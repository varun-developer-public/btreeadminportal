{% extends "base.html" %}
{% load custom_filter %}

{% block title %}Batch List{% endblock %}

{% block content %}
<style>
    .student-list-cell {
        max-width: 250px;
        max-height: 70px;
        overflow-y: auto;
        display: block;
    }
    .student-list-cell::-webkit-scrollbar {
        display: none;
    }
    .select2-container--open {
        z-index: 2000 !important;
    }
    .modal .select2-container {
        z-index: 2000 !important;
    }

     .modal-select2 .select2-container {
        width: 100% !important;
        padding: 0;
        z-index: 2000 !important;
    }
    #transferRequestsModal .table, #transactionModal .table {
        table-layout: fixed;
        width: 100%;
    }
    #transferRequestsModal .table td,
    #transferRequestsModal .table th,
    #transactionModal .table td,
    #transactionModal .table th {
        word-wrap: break-word;
        overflow-x: auto;
        width: auto;
    }
    #transferRequestsModal .table td:first-child,
    #transferRequestsModal .table th:first-child,
    #transactionModal .table td:first-child,
    #transactionModal .table th:first-child {
        word-wrap: break-word;
        overflow-x: auto;
        width: 30%;
    }
    #transferRequestsModal .table td::-webkit-scrollbar,
    #transactionModal .table td::-webkit-scrollbar {
        display: none;
    }
    #transferRequestsModal .table td ul,
    #transactionModal .table td ul {
        padding: 0;
    }
   .table-wrapper .dropdown {
       position: static;
   }
   .table-wrapper .dropdown-menu {
       z-index: 1050; /* Ensure it's above other elements */
   }
   .btn.btn-info i, .btn.btn-danger i {
    pointer-events: none;
}
.btn.btn-info, .btn.btn-danger {
    padding: 12px 10px;
}

</style>

  {% with page_tag="batch_page" %}
    {{ block.super }}   {# ensures only batch_page messages show #}
  {% endwith %}

<!-- Student List Modal -->
<div class="modal fade" id="studentListModal" tabindex="-1" aria-labelledby="studentListTitle" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="studentListTitle">Students in Batch</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Student ID</th>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Phone</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="studentListBody"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

 <!-- Add Student Modal -->
<div class="modal fade" id="addStudentModal" tabindex="-1" aria-labelledby="addStudentModalLabel" aria-hidden="true">
   <div class="modal-dialog">
       <div class="modal-content">
           <div class="modal-header">
               <h5 class="modal-title" id="addStudentModalLabel">Add Students to Batch</h5>
               <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
           </div>
           <form id="addStudentForm">
               <div class="modal-body">
                   <input type="hidden" id="addStudentBatchId">
                   <div class="mb-3">
                       <label for="studentsToAdd" class="form-label">Select Students</label>
                       <select class="form-select modal-select2" id="studentsToAdd" multiple required></select>
                   </div>
               </div>
               <div class="modal-footer">
                   <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                   <button type="submit" class="btn btn-primary">Add Students</button>
               </div>
           </form>
       </div>
   </div>
</div>


<!-- Transaction History Modal -->
<div class="modal fade" id="transactionModal" tabindex="-1" aria-labelledby="transactionTitle" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="transactionTitle">Batch Transactions</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Timestamp</th>
                            <th>Type</th>
                            <th>Details</th>
                            <th>User</th>
                        </tr>
                    </thead>
                    <tbody id="transactionListBody"></tbody>
                </table>
            </div>
            <div class="modal-footer">
                <a href="#" id="viewMoreLink" class="btn btn-primary">View More</a>
            </div>
        </div>
    </div>
</div>

<!-- Transfer Students Modal -->
<div class="modal fade" id="transferModal" tabindex="-1" aria-labelledby="transferModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="transferModalLabel">Transfer Students</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <form id="transferForm">
        {% csrf_token %}
        <div class="modal-body">
          <input type="hidden" id="fromBatchId">
          <div class="mb-3">
            <label class="form-label">Select Students</label>
            <select class="form-select modal-select2" id="transferStudents" multiple required></select>
          </div>
          <div class="mb-3">
            <label class="form-label">Target Batch</label>
            <select class="form-select modal-select2" id="toBatch" required></select>
          </div>
          <div class="mb-3">
            <label class="form-label">Reason</label>
            <textarea class="form-control" id="transferReason" rows="3" required></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">Submit Transfer</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Trainer Handover Modal -->
<div class="modal fade" id="handoverModal" tabindex="-1" aria-labelledby="handoverModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="handoverModalLabel">Trainer Handover</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <form id="handoverForm">
        {% csrf_token %}
        <div class="modal-body">
          <input type="hidden" id="handoverBatchId">
          <div class="mb-3">
            <label class="form-label">New Trainer</label>
            <select class="form-select modal-select2" id="newTrainer" required></select>
          </div>
          <div class="mb-3">
            <label class="form-label">Reason</label>
            <textarea class="form-control" id="handoverReason" rows="3" required></textarea>
          </div>
          <div class="mb-3">
            <label class="form-label">Handover Date</label>
            <input type="date" class="form-control" id="handoverDate" required>
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">Submit Handover</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Transfer Requests Modal -->
<div class="modal fade" id="transferRequestsModal" tabindex="-1" aria-labelledby="transferRequestsLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="transferRequestsLabel">Transfer Requests</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="transfer-requests-body">
        <p class="text-muted">Loading...</p>
      </div>
    </div>
  </div>
</div>

<!-- Handover Requests Modal -->
<div class="modal fade" id="handoverRequestsModal" tabindex="-1" aria-labelledby="handoverRequestsLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="handoverRequestsLabel">Handover Requests</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="handover-requests-body">
        <p class="text-muted">Loading...</p>
      </div>
    </div>
  </div>
</div>

<!-- Reject Transfer Modal -->
<div class="modal fade" id="rejectTransferModal" tabindex="-1" aria-labelledby="rejectTransferModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="rejectTransferModalLabel">Reject Transfer Request</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="rejectTransferForm">
                    <div class="mb-3">
                        <label for="rejectionReason" class="form-label">Reason for Rejection</label>
                        <textarea class="form-control" id="rejectionReason" rows="3" required></textarea>
                    </div>
                    <input type="hidden" id="rejectRequestId">
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="submitRejection()">Reject</button>
            </div>
        </div>
    </div>
</div>

<div class="list-container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="fas fa-users me-2"></i>Batch List</h2>
        <div class="d-flex gap-2">
            {% if user.role != 'trainer' %}
            <a href="{% url 'batchdb:create_batch' %}" class="btn-primary"><i class="fas fa-plus me-1"></i>Add Batch</a>
            {% endif %}

            {% if user.role == 'admin' %}
            <a href="{% url 'batchdb:import_batches' %}" class="btn-secondary"><i class="fas fa-file-import me-1"></i>Import</a>
            <a href="{% url 'batchdb:export_all_batches_data' %}" class="btn-secondary"><i class="fas fa-file-export me-1"></i>Export All</a>
            {% endif %}
        </div>
    </div>

    <!-- Filters -->
    <form method="get" class="filters mb-4">
        <div class="filter-row">
            {% if user.role != 'trainer' %}
            <div class="filter-group">
                {{ form.course.label_tag }}
                {{ form.course }}
            </div>
            <div class="filter-group">
                {{ form.trainer.label_tag }}
                {{ form.trainer }}
            </div>
            {% endif %}
            <div class="filter-group">
                {{ form.batch_status.label_tag }}
                {{ form.batch_status }}
            </div>
        </div>
        <div class="filter-row">
            <div class="filter-group">
                {{ form.q.label_tag }}
                {{ form.q }}
            </div>
            <div class="filter-group">
                {{ form.start_date.label_tag }}
                {{ form.start_date }}
            </div>
            <div class="filter-group">
                {{ form.end_date.label_tag }}
                {{ form.end_date }}
            </div>
            <div class="filter-group">
                {{ form.percentage_min.label_tag }}
                {{ form.percentage_min }}
            </div>
            <div class="filter-group">
                {{ form.percentage_max.label_tag }}
                {{ form.percentage_max }}
            </div>
            {% if user.role != 'trainer' %}
            <div class="filter-group">
                {{ form.time_slot.label_tag }}
                {{ form.time_slot }}
            </div>
            <div class="filter-group">
                {{ form.trainer_type.label_tag }}
                {{ form.trainer_type }}
            </div>
            {% endif %}
        </div>
        <div class="filter-actions">
            <button type="submit" class="btn-primary">Apply Filters</button>
            <a href="{% url 'batchdb:batch_list' %}" class="btn-secondary">Reset</a>
        </div>
    </form>

    <!-- Batch Table -->
    <div class="table-wrapper">
        <table>
            <thead>
                <tr>
                    <th>Batch ID</th>
                    <th>Course</th>
                    <th>Trainer</th>
                    <th>Trainer Type</th>
                    <th>Batch %</th>
                    <th>Status</th>
                    <th>Students</th>
                    <th>Start</th>
                    <th>End</th>
                    <th>Slot</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for batch in batches %}
                <tr>
                    <td><a href="{% url 'batchdb:batch_report' batch.pk %}"><span class="badge bg-secondary">{{ batch.batch_id }}</span></a></td>
                    <td>{{ batch.course.course_name }}</td>
                    <td>{{ batch.trainer.name }}</td>
                    <td>{{ batch.trainer.get_employment_type_display }}</td>
                    <td>{{ batch.batch_percentage|floatformat:2 }}%</td>
                    <td>
                        <span class="badge {% if batch.batch_status == 'YTS' %}bg-warning text-dark{% elif batch.batch_status == 'IP' %}bg-success{% else %}bg-secondary{% endif %}">
                            {{ batch.get_batch_status_display }}
                        </span>
                    </td>
                    <td>
                        <div class="student-list-cell">
                            {% for batch_student in batch.batchstudent_set.all %}
                                {% if batch_student.is_active %}
                                    <span class="badge bg-light text-dark">{{ batch_student.student.first_name }} {{ batch_student.student.last_name|default:"" }}</span>
                                {% endif %}
                            {% empty %}
                                <span class="text-muted">No students</span>
                            {% endfor %}
                        </div>
                    </td>
                    <td>{{ batch.start_date|date:"d-m-Y" }}</td>
                    <td>{{ batch.end_date|date:"d-m-Y" }}</td>
                    <td>{{ batch.get_slottime }}</td>
                    <td>
                        <div class="d-flex gap-2">
                            {% if user.role != 'trainer' %}
                            <div class="dropdown">
                                <button class="btn-secondary dropdown-toggle" data-bs-toggle="dropdown"><i class="fas fa-ellipsis-v"></i></button>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" href="javascript:void(0);" data-bs-toggle="modal" data-bs-target="#addStudentModal" data-batch-id="{{ batch.pk }}" data-course-id="{{ batch.course.pk }}"><i class="fas fa-user-plus me-1"></i>Add Student</a></li>
                                    <li><a class="dropdown-item" data-bs-toggle="modal" data-bs-target="#transferModal" data-batch-id="{{ batch.pk }}"><i class="fas fa-exchange-alt me-1"></i>Transfer Students</a></li>
                                    <li><a class="dropdown-item" data-bs-toggle="modal" data-bs-target="#handoverModal" data-batch-id="{{ batch.pk }}"><i class="fas fa-user-friends me-1"></i>Trainer Handover</a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li>
                                        <a class="dropdown-item" href="javascript:void(0);" onclick="viewTransferRequests('{{ batch.pk }}')">
                                            <i class="fas fa-exchange-alt me-1"></i>View Transfer Requests
                                        </a>
                                    </li>
                                    <li><a class="dropdown-item" href="javascript:void(0);" onclick="viewHandoverRequests('{{ batch.pk }}')"><i class="fas fa-user-friends me-1"></i>View Handover Requests</a></li>
                                    <li><a class="dropdown-item" href="javascript:void(0);" onclick="viewStudentList('{{ batch.pk }}')"><i class="fas fa-users me-1"></i>View Students</a></li>
                                    <li><a class="dropdown-item" href="javascript:void(0);" onclick="viewBatchTransactions('{{ batch.pk }}')"><i class="fas fa-history me-1"></i>View Transactions</a></li>
                                    <li><a class="dropdown-item" href="{% url 'batchdb:export_batch_data' batch.id %}"><i class="fas fa-file-export me-1"></i>Export Data</a></li>
                                </ul>
                            </div>
                            {% endif %}
                            <a href="{% url 'batchdb:update_batch' batch.pk %}" class="btn-update"><i class="fas fa-edit"></i></a>
                            {% if user.role == 'admin' %}
                            <a href="{% url 'batchdb:delete_batch' batch.pk %}" class="btn-danger"><i class="fas fa-trash"></i></a>
                            {% endif %}
                        </div>
                    </td>
                </tr>
                {% empty %}
                <tr><td colspan="11" class="text-center text-muted">No batches found</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Pagination -->
    <div class="pagination">
        <span class="step-links">
            {% if batches.has_previous %}
                <a href="?page=1&{{ request.GET.urlencode }}">&laquo; first</a>
                <a href="?page={{ batches.previous_page_number }}&{{ request.GET.urlencode }}">previous</a>
            {% endif %}
    
            <span class="current">
                Page {{ batches.number }} of {{ batches.paginator.num_pages }}.
            </span>
    
            {% if batches.has_next %}
                <a href="?page={{ batches.next_page_number }}&{{ request.GET.urlencode }}">next</a>
                <a href="?page={{ batches.paginator.num_pages }}&{{ request.GET.urlencode }}">last &raquo;</a>
            {% endif %}
        </span>
        <form method="get" class="page-search">
            <input type="number" name="page" min="1" max="{{ batches.paginator.num_pages }}" placeholder="Page">
            {% for key, value in request.GET.items %}
                {% if key != 'page' %}
                    <input type="hidden" name="{{ key }}" value="{{ value }}">
                {% endif %}
            {% endfor %}
            <button type="submit">Go</button>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}

<script>
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
const csrftoken = getCookie('csrftoken');
</script>


<script>
$(document).ready(function() {
    $('.django-select2').select2();
    $('#transferModal').on('shown.bs.modal', function () {
        $('#transferStudents, #toBatch').select2({
            dropdownParent: $('#transferModal')
        });
    });

    $('#handoverModal').on('shown.bs.modal', function () {
        $('#newTrainer').select2({
            dropdownParent: $('#handoverModal')
        });
    });
});

$('#addStudentModal').on('shown.bs.modal', function (e) {
   let batchId = $(e.relatedTarget).data('batch-id');
   let courseId = $(e.relatedTarget).data('course-id');
   $('#addStudentBatchId').val(batchId);

   $('#studentsToAdd').select2({
       dropdownParent: $('#addStudentModal'),
       placeholder: 'Select students',
       ajax: {
           url: "{% url 'batchdb:get_students_not_in_batch' %}",
           dataType: 'json',
           delay: 250,
           data: function (params) {
               return {
                   q: params.term, // search term
               };
           },
           processResults: function (data) {
               return {
                   results: $.map(data, function (item) {
                       return {
                           text: item.student_id + ' - ' + item.first_name + ' ' + (item.last_name ? item.last_name : ''),
                           id: item.id
                       }
                   })
               };
           },
           cache: true
       }
   });
});

$('#addStudentForm').on('submit', function(e) {
   e.preventDefault();
   let batchId = $('#addStudentBatchId').val();
   let studentIds = $('#studentsToAdd').val();
   $.ajax({
       url: `/api/batches/${batchId}/add_student/`,
       type: 'POST',
       contentType: 'application/json',
       data: JSON.stringify({ student_ids: studentIds }),
       headers: { "X-CSRFToken": csrftoken },
       success: function(response) {
           $('#addStudentModal').modal('hide');
           location.reload();
       },
       error: function(xhr) {
           alert("Error: " + xhr.responseText);
       }
   });
});

function removeStudent(batchId, studentId) {
   if (confirm('Are you sure you want to remove this student from the batch?')) {
       $.ajax({
           url: `/api/batches/${batchId}/remove_student/`,
           type: 'POST',
           contentType: 'application/json',
           data: JSON.stringify({ student_id: studentId }),
           headers: { "X-CSRFToken": csrftoken },
           success: function(response) {
               location.reload();
           },
           error: function(xhr) {
               alert("Error: " + xhr.responseText);
           }
       });
   }
}

// Load Students
function viewStudentList(batchId) {
    $('#studentListModal').modal('show');
    $.get("{% url 'batchdb:get_students_for_batch' %}", { batch_id: batchId }, function(data) {
        let list = $('#studentListBody').empty();
        if (data.students.length) {
            data.students.forEach(s => {
                if (s.is_active) {
                    list.append(`<tr>
                        <td><a href="/students/${s.student_id}/report/" class="view-link">${s.student_id}</a></td>
                        <td>${s.name}</td><td>${s.email}</td><td>${s.phone}</td>
                        <td>
                            <a href="{% url 'batchdb:student-batch-history' %}?student_id=${s.id}" class="btn btn-info me-2" title="View History">
                                <i class="fas fa-history fa-lg"></i>
                            </a>
                            {% if user.role == 'admin' %}
                            <button class="btn btn-danger" onclick="removeStudent(${batchId}, ${s.id})" title="Remove Student">
                                <i class="fas fa-user-minus fa-lg"></i>
                            </button>
                            {% endif %}
                        </td>
                    </tr>`);
                }
            });
        } else list.html("<tr><td colspan='4'>No students</td></tr>");
    });
}

// Load Transactions
function viewBatchTransactions(batchId) {
    $('#transactionModal').modal('show');
    var reportUrl = "{% url 'batchdb:batch_report' 0 %}".replace('0', batchId);
    $('#viewMoreLink').attr('href', reportUrl);

    $.get("{% url 'batchdb:batchdb_api:batchtransaction-list' %}", { batch_id: batchId, page_size: 5 }, function(data) {
        let list = $('#transactionListBody').empty();
        let transactions = data.results || data;
        if (transactions.length) {
            transactions.slice(0, 5).forEach(t => {
                let badge = t.transaction_type.includes("ADD") ? "bg-success" :
                            t.transaction_type.includes("REMOVE") ? "bg-danger" :
                            t.transaction_type.includes("TRANSFER") ? "bg-warning text-dark" : "bg-info";
                list.append(`<tr>
                    <td>${new Date(t.timestamp).toLocaleString()}</td>
                    <td><span class="badge ${badge}">${t.transaction_type}</span></td>
                    <td>
                        ${t.details && typeof t.details === 'object' ?
                            `<ul>
                                ${Object.entries(t.details).map(([key, value]) => {
                                    if (key === "deactivated_at" && value) {
                                        let dateOnly = new Date(value).toLocaleDateString();
                                        return `<li><strong>${key.charAt(0).toUpperCase() + key.slice(1)}:</strong> ${dateOnly}</li>`;
                                    }
                                    return `<li><strong>${key.charAt(0).toUpperCase() + key.slice(1)}:</strong> ${value}</li>`;
                                }).join('')}
                            </ul>` : t.details || '-'
                        }
                    </td>
                    <td>${t.user_name}</td>
                </tr>`);
            });
        } else list.html("<tr><td colspan='4'>No transactions</td></tr>");
    });
}

// Transfer Modal
$('#transferModal').on('show.bs.modal', function (e) {
    let batchId = $(e.relatedTarget).data('batch-id');
    $('#fromBatchId').val(batchId);

    // Fetch students for the selected batch
    $.get("{% url 'batchdb:get_students_for_batch' %}", { batch_id: batchId }, function(data) {
        let select = $('#transferStudents').empty();
        if (data.students.length) {
            data.students.forEach(s => {
                if (s.is_active) {
                    select.append(`<option value="${s.id}">${s.student_id} - ${s.name}</option>`);
                }
            });
        } else {
            select.html("<option disabled>No active students to transfer</option>");
        }
        select.select2({ placeholder: 'Select students', width: '100%' });
    });

    // Fetch available batches for transfer
    $.get("{% url 'batchdb:batchdb_api:available-batches-for-transfer' %}", { from_batch_id: batchId }, function(data) {
        let select = $('#toBatch').empty().append("<option value=''>Select a batch</option>");
        if (data.length) {
            data.forEach(b => select.append(`<option value="${b.id}">${b.batch_id} - ${b.course_name}</option>`));
        } else {
            select.html("<option disabled>No compatible batches available</option>");
        }
        select.select2({ placeholder: 'Select target batch', width: '100%' });
    });
});

// Handover Modal
$('#handoverModal').on('show.bs.modal', function (e) {
    let batchId = $(e.relatedTarget).data('batch-id');
    $('#handoverBatchId').val(batchId);
    $.get("{% url 'batchdb:batchdb_api:available-trainers-for-handover' %}", { batch_id: batchId }, function(data) {
        let select = $('#newTrainer').empty().append("<option value=''>Select a trainer</option>");
        if (data.length) {
            data.forEach(t => select.append(`<option value="${t.id}">${t.trainer_id}-${t.name}</option>`));
        } else select.html("<option disabled>No trainers available</option>");
        select.select2({ placeholder: 'Select trainer', width: '100%' });
    });
});

// Transfer request submit
$('#transferForm').on('submit', function(e) {
  e.preventDefault();

  let data = {
    from_batch: $('#fromBatchId').val(),
    students: $('#transferStudents').val(),
    to_batch: $('#toBatch').val(),
    remarks: $('#transferReason').val()
  };

  $.ajax({
    url: "{% url 'batchdb:batchdb_api:transferrequest-list' %}",
    type: "POST",
    contentType: "application/json",
    data: JSON.stringify(data),
    headers: { "X-CSRFToken": "{{ csrf_token }}" },
    success: function(response) {
      $('#transferModal').modal('hide');
      alert("✅ Transfer request submitted successfully!");
      location.reload();
    },
    error: function(xhr) {
      alert("❌ Error: " + xhr.responseText);
    }
  });
});

// Trainer handover submit
$('#handoverForm').on('submit', function(e) {
  e.preventDefault();

  let data = {
    batch: $('#handoverBatchId').val(),
    to_trainer: $('#newTrainer').val(),
    remarks: $('#handoverReason').val(),
    handover_date: $('#handoverDate').val()
  };

  $.ajax({
    url: "{% url 'batchdb:batchdb_api:trainerhandover-list' %}",
    type: "POST",
    contentType: "application/json",
    data: JSON.stringify(data),
    headers: { "X-CSRFToken": "{{ csrf_token }}" },
    success: function(response) {
      $('#handoverModal').modal('hide');
      alert("✅ Trainer handover submitted successfully!");
      location.reload();
    },
    error: function(xhr) {
      alert("❌ Error: " + xhr.responseText);
    }
  });
});

</script>
<!-- Transfer Request  -->
<script>
function viewTransferRequests(batchId) {
    $("body").data("current-batch", batchId);  
    $("#transfer-requests-body").html("<p class='text-muted'>Loading...</p>");
    $("#transferRequestsModal").modal("show");

    $.ajax({
        url: "/batches/api/transfer-requests/?to_batch=" + batchId, 
        type: "GET",
        success: function(data) {
            if (data.length === 0) {
                $("#transfer-requests-body").html("<p class='text-muted'>No transfer requests found.</p>");
                return;
            }

            let html = `
                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th>Student</th>
                            <th>Student.Cnt</th>
                            <th>From Batch</th>
                            <th>To Batch</th>
                            <th>Status</th>
                            <th>Remarks</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            data.forEach(req => {
                let students = req.students_data.map(s => `${s.name}-${s.id}`).join(", ");
                html += `
                    <tr>
                        <td>${students}</td>
                        <td>${req.students_data.length}</td>
                        <td>${req.from_batch_code}</td>
                        <td>${req.to_batch_code}</td>
                        <td>
                            <span class="badge ${req.status === 'PENDING' ? 'bg-warning' : req.status === 'APPROVED' ? 'bg-success' : 'bg-danger'}">
                                ${req.status}
                            </span>
                        </td>
                        <td>${req.remarks || ''}</td>
                        <td>
                            ${req.status === "PENDING" ? `
                                <button class="btn btn-success btn-sm" onclick="updateTransferStatus(${req.id}, 'approve')"><i class="fas fa-check"></i> Approve</button>
                                <button class="btn btn-danger btn-sm" onclick="openRejectModal(${req.id})"><i class="fas fa-times"></i> Reject</button>
                            ` : "-"}
                        </td>
                    </tr>
                `;
            });

            html += "</tbody></table>";
            $("#transfer-requests-body").html(html);
        },
        error: function() {
            $("#transfer-requests-body").html("<p class='text-danger'>Failed to load requests.</p>");
        }
    });
}


function openRejectModal(requestId) {
    $('#rejectRequestId').val(requestId);
    $('#rejectTransferModal').modal('show');
}

function submitRejection() {
    let requestId = $('#rejectRequestId').val();
    let reason = $('#rejectionReason').val();
    if (reason.trim() === '') {
        alert('Rejection reason cannot be empty.');
        return;
    }
    updateTransferStatus(requestId, 'reject', reason);
    $('#rejectTransferModal').modal('hide');
    $('#rejectionReason').val('');
}

function updateTransferStatus(requestId, actionType, remarks) {
    let url = `/batches/api/transfer-requests/${requestId}/${actionType}/`;
    let data = { remarks: remarks || (actionType === "approve" ? "Approved via modal" : "Rejected via modal") };

    $.ajax({
        url: url,
        type: "POST",
        contentType: "application/json",
        data: JSON.stringify(data),
        headers: { "X-CSRFToken": "{{ csrf_token }}" },
        dataType: "json",
        success: function(response) {
            let currentBatch = $("body").data("current-batch");
            viewTransferRequests(currentBatch);
            const toastHtml = `<div class="alert alert-success alert-dismissible fade show" role="alert">
                ${response.message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>`;
            $("body").prepend(toastHtml);
        },
        error: function(xhr) {
            const msg = xhr.responseJSON?.message || JSON.stringify(xhr.responseJSON) || xhr.responseText;
            const toastHtml = `<div class="alert alert-danger alert-dismissible fade show" role="alert">
                ❌ ${msg}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>`;
            $("body").prepend(toastHtml);
        }
    });
}

</script>

<!-- Handover Request -->
<script>
function viewHandoverRequests(batchId) {
    $("body").data("current-batch", batchId);
    $("#handover-requests-body").html("<p class='text-muted'>Loading...</p>");
    $("#handoverRequestsModal").modal("show");

    $.ajax({
        url: "/batches/api/trainer-handovers/?batch_id=" + batchId,
        type: "GET",
        success: function(data) {
            if (data.length === 0) {
                $("#handover-requests-body").html("<p class='text-muted'>No handover requests found.</p>");
                return;
            }

            let html = `
                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th>From Trainer</th>
                            <th>To Trainer</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            data.forEach(req => {
                html += `
                    <tr>
                        <td>${req.from_trainer_name}</td>
                        <td>${req.to_trainer_name}</td>
                        <td>
                            <span class="badge ${req.status === 'PENDING' ? 'bg-warning' : req.status === 'APPROVED' ? 'bg-success' : 'bg-danger'}">
                                ${req.status}
                            </span>
                        </td>
                        <td>
                            ${req.status === "PENDING" ? `
                                <button class="btn btn-success btn-sm" onclick="updateHandoverStatus(${req.id}, 'approve')">Approve</button>
                                <button class="btn btn-danger btn-sm" onclick="updateHandoverStatus(${req.id}, 'reject')">Reject</button>
                            ` : "-"}
                        </td>
                    </tr>
                `;
            });

            html += "</tbody></table>";
            $("#handover-requests-body").html(html);
        },
        error: function() {
            $("#handover-requests-body").html("<p class='text-danger'>Failed to load requests.</p>");
        }
    });
}

function updateHandoverStatus(requestId, actionType) {
    let url = `/batches/api/trainer-handovers/${requestId}/${actionType}/`;
    let data = { remarks: `${actionType.charAt(0).toUpperCase() + actionType.slice(1)}ed via modal` };

    $.ajax({
        url: url,
        type: "POST",
        contentType: "application/json",
        data: JSON.stringify(data),
        headers: { "X-CSRFToken": "{{ csrf_token }}" },
        dataType: "json",
        success: function(response) {
            let currentBatch = $("body").data("current-batch");
            viewHandoverRequests(currentBatch); // reload modal
            const toastHtml = `<div class="alert alert-success alert-dismissible fade show" role="alert">
                ${response.message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>`;
            $("body").prepend(toastHtml);
        },
        error: function(xhr) {
            const msg = xhr.responseJSON?.message || JSON.stringify(xhr.responseJSON) || xhr.responseText;
            const toastHtml = `<div class="alert alert-danger alert-dismissible fade show" role="alert">
                ❌ ${msg}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>`;
            $("body").prepend(toastHtml);
        }
    });
}
</script>
<script>
function viewHandoverRequests(batchId) {
    $("body").data("current-batch", batchId);
    $("#handover-requests-body").html("<p class='text-muted'>Loading...</p>");
    $("#handoverRequestsModal").modal("show");

    $.ajax({
        url: "/batches/api/trainer-handovers/?batch_id=" + batchId,
        type: "GET",
        success: function(data) {
            if (data.length === 0) {
                $("#handover-requests-body").html("<p class='text-muted'>No handover requests found.</p>");
                return;
            }

            let html = `
                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th>From Trainer</th>
                            <th>To Trainer</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            data.forEach(req => {
                html += `
                    <tr>
                        <td>${req.from_trainer_name}</td>
                        <td>${req.to_trainer_name}</td>
                        <td>
                            <span class="badge ${req.status === 'PENDING' ? 'bg-warning' : req.status === 'APPROVED' ? 'bg-success' : 'bg-danger'}">
                                ${req.status}
                            </span>
                        </td>
                        <td>
                            ${req.status === "PENDING" ? `
                                <button class="btn btn-success btn-sm" onclick="updateHandoverStatus(${req.id}, 'approve')">Approve</button>
                                <button class="btn btn-danger btn-sm" onclick="updateHandoverStatus(${req.id}, 'reject')">Reject</button>
                            ` : "-"}
                        </td>
                    </tr>
                `;
            });

            html += "</tbody></table>";
            $("#handover-requests-body").html(html);
        },
        error: function() {
            $("#handover-requests-body").html("<p class='text-danger'>Failed to load requests.</p>");
        }
    });
}

function updateHandoverStatus(requestId, actionType) {
    let url = `/batches/api/trainer-handovers/${requestId}/${actionType}/`;
    let data = { remarks: `${actionType.charAt(0).toUpperCase() + actionType.slice(1)}ed via modal` };

    $.ajax({
        url: url,
        type: "POST",
        contentType: "application/json",
        data: JSON.stringify(data),
        headers: { "X-CSRFToken": "{{ csrf_token }}" },
        dataType: "json",
        success: function(response) {
            let currentBatch = $("body").data("current-batch");
            viewHandoverRequests(currentBatch); // reload modal
            const toastHtml = `<div class="alert alert-success alert-dismissible fade show" role="alert">
                ${response.message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>`;
            $("body").prepend(toastHtml);
        },
        error: function(xhr) {
            const msg = xhr.responseJSON?.message || JSON.stringify(xhr.responseJSON) || xhr.responseText;
            const toastHtml = `<div class="alert alert-danger alert-dismissible fade show" role="alert">
                ❌ ${msg}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>`;
            $("body").prepend(toastHtml);
        }
    });
}
</script>

{{ form.media.js }}
{% endblock %}

{% block extra_css %}
{{ form.media.css }}
{% endblock %}
