{% extends "base.html" %}
{% block title %}Update Trainer{% endblock %}
{% load static country_codes %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/student_form_modern.css' %}">
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<style>
    .collapse.show {
        transition: height 0.3s ease;
    }
    .select2-container {
        width: 100% !important;
    }
    .select2-container--default .select2-selection--multiple{
        border: none !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="student-form-container">
    <div class="form-header">
        <h1>Update Trainer</h1>
    </div>

    <form method="post" class="student-form" enctype="multipart/form-data">
        {% csrf_token %}
        {% if form.errors or formset.errors %}
            <div class="alert alert-danger">
                <strong>Error:</strong>
                <ul>
                    {% for error in form.non_field_errors %}
                        <li>{{ error }}</li>
                    {% endfor %}
                    {% for error in formset.non_form_errors %}
                        <li>{{ error }}</li>
                    {% endfor %}
                    {% for field in form %}
                        {% for error in field.errors %}
                            <li>{{ field.label }}: {{ error }}</li>
                        {% endfor %}
                    {% endfor %}
                    {% for form in formset %}
                        {% for field in form %}
                            {% for error in field.errors %}
                                <li>{{ form.prefix }}-{{ field.label }}: {{ error }}</li>
                            {% endfor %}
                        {% endfor %}
                    {% endfor %}
                </ul>
            </div>
        {% endif %}
        <div class="form-section-card">
            <div class="form-section-header">
                <h5 style="color: white;"><i class="fas fa-user me-2" style="color: white;"></i>Trainer Details</h5>
            </div>
            <div class="form-section-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            {{ form.name.label_tag }}
                            {{ form.name }}
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            {{ form.email.label_tag }}
                            {{ form.email }}
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            {{ form.country_code.label_tag }}
                            <select id="id_country_code_select" class="form-control country-code-select">
                                {% get_country_codes as countries %}
                                {% for code, name, alpha2 in countries %}
                                    <option value="{{ alpha2 }}" data-code="{{ code }}" {% if form.instance.country_code == code %}selected{% endif %}>{{ name }}</option>
                                {% endfor %}
                            </select>
                            {{ form.country_code }}
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            {{ form.phone_number.label_tag }}
                            {{ form.phone_number }}
                        </div>
                    </div>
                </div>
                <div class="row">   
                    <div class="col-md-6">
                        <div class="form-group">
                            {{ form.location.label_tag }}
                            {{ form.location }}
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group" id="other_location_group" style="display: none;">
                            {{ form.other_location.label_tag }}
                            {{ form.other_location }}
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            {{ form.years_of_experience.label_tag }}
                            {{ form.years_of_experience }}
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            {{ form.stack.label_tag }}
                            {{ form.stack }}
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            {{ form.employment_type.label_tag }}
                            {{ form.employment_type }}
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            {{ form.profile.label_tag }}
                            {{ form.profile }}
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            {{ form.demo_link.label_tag }}
                            {{ form.demo_link }}
                        </div>
                    </div>
                   <div class="col-md-6">
                       <div class="form-group">
                           {{ form.is_active.label_tag }}
                           {{ form.is_active }}
                       </div>
                   </div>
                </div>
            </div>
        </div>
        
        <div class="form-section-card">
            <div class="form-section-header">
                <h5 style="color: white;"><i class="fas fa-clock me-2" style="color: white;"></i>Available Slots</h5>
            </div>
            <div class="form-section-body">
                {{ form.timing_slots }}
                <div id="timing-slots-container">
                    <!-- Timing slots will be added here dynamically -->
                </div>
                <button type="button" id="add-slot-btn" class="btn btn-secondary mt-2">Add slot</button>
            </div>
        </div>

        <div class="form-section-card">
            <div class="form-section-header">
                <h5 style="color: white;"><i class="fas fa-money-bill-wave me-2" style="color: white;"></i>Commercials</h5>
            </div>
            <div class="form-section-body">
                {{ form.commercials }}
                <div id="commercials-container">
                    <!-- Commercials will be added here dynamically -->
                </div>
                <button type="button" id="add-commercial-btn" class="btn btn-secondary mt-2">Add Commercial</button>
            </div>
        </div>

        <div class="form-actions">
            <button type="submit" class="btn btn-primary">Update Trainer</button>
        </div>
    </form>
</div>

{% block extra_js %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script>
$(document).ready(function() {
    var $countryCodeSelect = $('#id_country_code_select');
    var $countryCodeHidden = $('#id_country_code');

    $countryCodeSelect.on('change', function() {
        var selectedOption = $(this).find('option:selected');
        var countryCode = selectedOption.data('code');
        $countryCodeHidden.val(countryCode);
    });

    // Set initial value for hidden input
    var initialSelectedOption = $countryCodeSelect.find('option:selected');
    if (initialSelectedOption.length) {
        $countryCodeHidden.val(initialSelectedOption.data('code'));
    }
    $('#id_stack').select2();

    $('#id_location').change(function() {
        if ($(this).val() === 'Others') {
            $('#other_location_group').show();
        } else {
            $('#other_location_group').hide();
        }
    }).trigger('change');

    const slotsContainer = $('#timing-slots-container');
    const hiddenInput = $('#id_timing_slots');
    let slots = [];

    function renderSlots() {
        slotsContainer.empty();
        slots.forEach((slot, index) => {
            const slotHtml = `
                <div class="row mb-2" data-index="${index}">
                    <div class="col-md-3">
                        <label>Start Time</label>
                        <input type="time" class="form-control start-time" value="${slot.start_time}">
                    </div>
                    <div class="col-md-3">
                        <label>End Time</label>
                        <input type="time" class="form-control end-time" value="${slot.end_time}">
                    </div>
                    <div class="col-md-2">
                        <label>Availability</label>
                        <select class="form-control availability">
                            <option value="WE" ${slot.availability === 'WE' ? 'selected' : ''}>Weekend</option>
                            <option value="WD" ${slot.availability === 'WD' ? 'selected' : ''}>Weekday</option>
                            <option value="WE/WD" ${slot.availability === 'WE/WD' ? 'selected' : ''}>Weekend/Weekday</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label>Mode</label>
                        <select class="form-control mode">
                            <option value="Online" ${slot.mode === 'Online' ? 'selected' : ''}>Online</option>
                            <option value="Offline" ${slot.mode === 'Offline' ? 'selected' : ''}>Offline</option>
                            <option value="Online/Offline" ${slot.mode === 'Online/Offline' ? 'selected' : ''}>Online/Offline</option>
                        </select>
                    </div>
                    <div class="col-md-2 d-flex align-items-end">
                        <button type="button" class="btn btn-danger remove-slot-btn">Remove</button>
                    </div>
                </div>
            `;
            slotsContainer.append(slotHtml);
        });
        hiddenInput.val(JSON.stringify(slots));
    }

    $('#add-slot-btn').click(function() {
        slots.push({ start_time: '', end_time: '', availability: 'WD', mode: 'Offline' });
        renderSlots();
    });

    slotsContainer.on('click', '.remove-slot-btn', function() {
        const index = $(this).closest('.row').data('index');
        slots.splice(index, 1);
        renderSlots();
    });

    slotsContainer.on('change', '.start-time, .end-time, .mode, .availability', function() {
        const index = $(this).closest('.row').data('index');
        const startTime = $(this).closest('.row').find('.start-time').val();
        const endTime = $(this).closest('.row').find('.end-time').val();
        const availability = $(this).closest('.row').find('.availability').val();
        const mode = $(this).closest('.row').find('.mode').val();
        slots[index] = { start_time: startTime, end_time: endTime, availability: availability, mode: mode };
        hiddenInput.val(JSON.stringify(slots));
    });

    // Initial render if there are existing slots (for update form)
    try {
        const initialSlots = JSON.parse(hiddenInput.val());
        if (Array.isArray(initialSlots)) {
            slots = initialSlots;
        }
    } catch (e) {
        // Ignore parsing errors, start with empty slots
    }
    renderSlots();

    const commercialsContainer = $('#commercials-container');
    const commercialsHiddenInput = $('#id_commercials');
    let commercials = [];

    function renderCommercials() {
        commercialsContainer.empty();
        commercials.forEach((commercial, index) => {
            let inputs = '';
            if (commercial.commercial_type === 'studentwise') {
                inputs = `
                    <div class="col-md-4">
                        <label>1st Student Payment</label>
                        <input type="number" class="form-control first-student-payment" value="${commercial.first_student_payment || ''}">
                    </div>
                    <div class="col-md-4">
                        <label>Other Students Payment</label>
                        <input type="number" class="form-control second-student-payment" value="${commercial.second_student_payment || ''}">
                    </div>
                `;
            } else {
                inputs = `
                    <div class="col-md-8">
                        <label>Payment</label>
                        <input type="number" class="form-control payment" value="${commercial.payment || ''}">
                    </div>
                `;
            }

            const commercialHtml = `
                <div class="row mb-2" data-index="${index}">
                    <div class="col-md-4">
                        <label>Commercial Type</label>
                        <select class="form-control commercial-type">
                            <option value="studentwise" ${commercial.commercial_type === 'studentwise' ? 'selected' : ''}>Student-wise</option>
                            <option value="one_on_one" ${commercial.commercial_type === 'one_on_one' ? 'selected' : ''}>One on One</option>
                            <option value="batch_wise" ${commercial.commercial_type === 'batch_wise' ? 'selected' : ''}>Batch-wise</option>
                        </select>
                    </div>
                    ${inputs}
                    <div class="col-md-2 d-flex align-items-end">
                        <button type="button" class="btn btn-danger remove-commercial-btn">Remove</button>
                    </div>
                </div>
            `;
            commercialsContainer.append(commercialHtml);
        });
        commercialsHiddenInput.val(JSON.stringify(commercials));
    }

    $('#add-commercial-btn').click(function() {
        commercials.push({ commercial_type: 'studentwise' });
        renderCommercials();
    });

    commercialsContainer.on('click', '.remove-commercial-btn', function() {
        const index = $(this).closest('.row').data('index');
        commercials.splice(index, 1);
        renderCommercials();
    });

    commercialsContainer.on('change', '.commercial-type', function() {
        const index = $(this).closest('.row').data('index');
        commercials[index].commercial_type = $(this).val();
        renderCommercials();
    });

    commercialsContainer.on('change', '.first-student-payment, .second-student-payment, .payment', function() {
        const index = $(this).closest('.row').data('index');
        if (commercials[index].commercial_type === 'studentwise') {
            commercials[index].first_student_payment = $(this).closest('.row').find('.first-student-payment').val();
            commercials[index].second_student_payment = $(this).closest('.row').find('.second-student-payment').val();
        } else {
            commercials[index].payment = $(this).closest('.row').find('.payment').val();
        }
        commercialsHiddenInput.val(JSON.stringify(commercials));
    });

    // Initial render for commercials
    try {
        const initialCommercials = JSON.parse(commercialsHiddenInput.val());
        if (Array.isArray(initialCommercials)) {
            commercials = initialCommercials;
        }
    } catch (e) {
        // Ignore parsing errors, start with empty commercials
    }
    renderCommercials();
});
</script>
{% endblock %}
{% endblock %}