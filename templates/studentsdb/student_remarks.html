{% extends "base.html" %}
{% block title %}Student Remarks{% endblock %}
{% load static %}
{% block content %}
<style>
  #studentRemarks .chat-container{background:#f7f8fb;border-radius:16px;padding:12px;display:flex;flex-direction:column;gap:8px;overflow-y:auto}
  #studentRemarks .chat-container{-ms-overflow-style:none;scrollbar-width:none}
  #studentRemarks .chat-container::-webkit-scrollbar{display:none}
  #studentRemarks .msg-row{display:flex;gap:8px;align-items:flex-end}
  #studentRemarks .msg-row.left{justify-content:flex-start}
  #studentRemarks .msg-row.right{justify-content:flex-end}
  #studentRemarks .time-row{margin:2px 8px 10px;opacity:.75}
  #studentRemarks .time-row.right{text-align:right}
  #studentRemarks .time-row.left{text-align:left}
  #studentRemarks .avatar{width:28px;height:28px;border-radius:50%;background:#eef0f5;color:#111827;display:flex;align-items:center;justify-content:center;font-weight:600;font-size:.85rem;border:1px solid #e5e7eb}
  #studentRemarks .msg{max-width:75%;padding:10px 12px;border-radius:14px;line-height:1.4}
  #studentRemarks .msg-header{font-size:.95rem;margin-bottom:4px}
  #studentRemarks .msg-text{margin:0}
  #studentRemarks .msg-time{margin-top:6px;opacity:.75}
  #studentRemarks .msg-left .msg-time{text-align:left}
  #studentRemarks .msg-right .msg-time{text-align:right}
  #studentRemarks .msg-left{align-self:flex-start;background:#ffffff;border:1px solid #eef0f5}
  #studentRemarks .msg-right{align-self:flex-end;background:#6f43f5;color:#fff}
  #studentRemarks .date-sep{align-self:center;background:#eef0f5;color:#374151;padding:4px 10px;border-radius:12px;font-size:.85rem;margin:8px 0}
  #studentRemarks .chat-input{border:1px solid #e5e7eb;border-radius:18px;padding:10px 14px;background:#f7f8fb;display:flex;align-items:center;gap:10px}
  #studentRemarks .chat-actions{gap:8px;margin-left:auto;align-items:center}
  #studentRemarks .chat-icon-btn{background:transparent;border:none;color:#6b7280;width:26px;height:26px;display:flex;align-items:center;justify-content:center;border-radius:50%}
  #studentRemarks .send-btn{border-radius:18px;height:30px;width:36px;display:flex;align-items:center;justify-content:center;padding:0 10px}
  #studentRemarks .remarks-list{max-height:calc(70vh - 50px);overflow-y:auto;border:1px solid #e5e7eb;border-radius:10px;background:#fff;-ms-overflow-style:none;scrollbar-width:none}
  #studentRemarks .remarks-list::-webkit-scrollbar{display:none}
  #studentRemarks .remarks-item{display:flex;gap:12px;padding:10px 12px;border-bottom:1px solid #f0f0f0;cursor:pointer;align-items:center}
  #studentRemarks .remarks-item:hover{background:#f7f8fb}
  #studentRemarks .remarks-avatar{width:36px;height:36px;border-radius:50%;background:#eef0f5;color:#111827;display:flex;align-items:center;justify-content:center;font-weight:600}
  #studentRemarks .remarks-name{font-weight:600}
  #studentRemarks .remarks-meta{font-size:.8rem;color:#6b7280}
  #studentRemarks .remarks-preview{font-size:.9rem;color:#374151;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:260px}
  #studentRemarks .remarks-time{font-size:.8rem;color:#6b7280;margin-left:8px;white-space:nowrap}
  #studentRemarks .filter-form{gap:.5rem;align-items: baseline !important}
  #studentRemarks .remarks-input{width:280px;padding:8px 12px;border:1px solid #e5e7eb;border-radius:10px;background:#fff;outline:none}
  #studentRemarks .remarks-input:focus{border-color:#6f43f5;box-shadow:0 0 0 3px rgba(111,67,245,.15)}
  #studentRemarks .remarks-select{padding:8px 10px;border:1px solid #e5e7eb;border-radius:10px;background:#fff;outline:none}
  #studentRemarks .remarks-select:focus{border-color:#6f43f5;box-shadow:0 0 0 3px rgba(111,67,245,.15)}
  #studentRemarks .remarks-pagination .pagination{margin:0}
  #studentRemarks .remarks-pagination .page-link{border-radius:8px;border:1px solid #e5e7eb;color:#374151}
  #studentRemarks .remarks-pagination .page-item.active .page-link{background:#6f43f5;color:#fff;border-color:#6f43f5}
  #studentRemarks .remarks-list{margin-top:0}
  #studentRemarks .remarks-card{height:70vh;display:flex;flex-direction:column}
  #studentRemarks .remarks-card .card-body{display:flex;flex-direction:column;height:100%}
  #studentRemarks #remarks-messages{flex:1 1 auto;min-height:0;overflow-y:auto}
  /* Hide breadcrumb to move content to top */
  nav[aria-label="breadcrumb"] { display: none !important; }
  /* Sticky header */
  #studentRemarks .sticky-header {
    position: -webkit-sticky;
    position: sticky;
    top: -6px; /* Height of navbar */
    z-index: 99;
    background-color: #f5f7fa;
    margin-bottom: -10px !important;
  }

  /* Unread Styling - Blue Theme */
  #studentRemarks .remarks-item.state-unread {
    background-color: #e3f2fd !important; /* Light blue highlight */
  }
  #studentRemarks .remarks-item.state-unread .remarks-name {
    color: #0d47a1 !important; /* Darker blue for name */
    font-weight: 700 !important;
  }
  #studentRemarks .remarks-item.state-unread .remarks-preview,
  #studentRemarks .remarks-item.state-unread .remarks-time {
    font-weight: 700 !important;
    color: #111827 !important;
  }

  /* Priority + Unread: Light Red/Orange */
  #studentRemarks .remarks-item.state-priority-unread {
    background-color: #ffebee !important; /* Light red/pink */
  }
  #studentRemarks .remarks-item.state-priority-unread .remarks-name {
    color: #b71c1c !important; /* Dark red for name */
    font-weight: 700 !important;
  }
  #studentRemarks .remarks-item.state-priority-unread .remarks-preview,
  #studentRemarks .remarks-item.state-priority-unread .remarks-time {
    font-weight: 700 !important;
    color: #111827 !important;
  }

  /* Priority + Read: Light Yellow */
  #studentRemarks .remarks-item.state-priority-read {
    background-color: #fffde7 !important; /* Light yellow */
  }
  #studentRemarks .remarks-item.state-priority-read .remarks-name {
    color: #111827 !important; /* Normal text color */
    font-weight: 600 !important;
  }
  
  #studentRemarks .text-success { color: #128C7E !important; } /* WhatsApp Teal/Green for Time */
  #studentRemarks .badge.bg-primary { background-color: #25D366 !important; } /* WhatsApp Bright Green for Badge */
  
  /* Priority Star Colors */
  #studentRemarks .text-danger { color: #dc3545 !important; } /* High Priority - Red */
  #studentRemarks .text-warning { color: #ffc107 !important; } /* Medium Priority - Yellow/Gold */
  #studentRemarks .text-primary { color: #0d6efd !important; } /* Low Priority - Blue */
</style>
<div id="studentRemarks" class="container-fluid">
  <div class="d-flex justify-content-between align-items-center mb-3 sticky-header">
    <h2 class="mb-0"><i class="fas fa-file-alt me-2"></i>Student Remarks</h2>
    <form method="get" class="filter-form d-flex align-items-center gap-2">
      <input type="text" name="q" value="{{ form.cleaned_data.q|default:'' }}" placeholder="Search by name, email, phone, or Student ID" class="remarks-input">
      <select name="course_status" class="remarks-select" onchange="this.form.submit()">
        <option value="">All Statuses</option>
        {% for val,label in form.fields.course_status.choices %}
          {% if val %}
            <option value="{{ val }}" {% if form.cleaned_data.course_status == val %}selected{% endif %}>{{ label }}</option>
          {% endif %}
        {% endfor %}
      </select>
      <select name="payment_status" class="remarks-select" onchange="this.form.submit()">
        <option value="">All Statuses</option>
        <option value="Pending" {% if form.cleaned_data.payment_status == 'Pending' %}selected{% endif %}>Pending</option>
        <option value="Paid" {% if form.cleaned_data.payment_status == 'Paid' %}selected{% endif %}>Paid</option>
      </select>
      <select name="priority" class="remarks-select" onchange="this.form.submit()">
        <option value="">Priority</option>
        <option value="high" {% if selected_priority == 'high' %}selected{% endif %}>High</option>
        <option value="medium" {% if selected_priority == 'medium' %}selected{% endif %}>Medium</option>
        <option value="low" {% if selected_priority == 'low' %}selected{% endif %}>Low</option>
      </select>
      <select name="hashtag" class="remarks-select" onchange="this.form.submit()">
        <option value="">Hashtag</option>
        <option value="placement" {% if selected_hashtag == 'placement' %}selected{% endif %}>#Placement</option>
        <option value="class" {% if selected_hashtag == 'class' %}selected{% endif %}>#Class</option>
        <option value="payment" {% if selected_hashtag == 'payment' %}selected{% endif %}>#Payment</option>
        <option value="followups" {% if selected_hashtag == 'followups' %}selected{% endif %}>#Followups</option>
        <option value="important" {% if selected_hashtag == 'important' %}selected{% endif %}>#Important</option>
      </select>
      <a href="{% url 'student_remarks' %}" class="btn btn-secondary" title="Reset Filters"><i class="fas fa-redo"></i></a>
    </form>
  </div>
  <div class="row g-3">
    <div class="col-md-4">
      <nav class="remarks-pagination mb-2 d-flex justify-content-end">
        <ul class="pagination pagination-sm">
          {% if students.has_previous %}
            <li class="page-item"><a class="page-link" href="?page=1&{{ query_params }}">&laquo;</a></li>
            <li class="page-item"><a class="page-link" href="?page={{ students.previous_page_number }}&{{ query_params }}">Prev</a></li>
          {% else %}
            <li class="page-item disabled"><span class="page-link">&laquo;</span></li>
            <li class="page-item disabled"><span class="page-link">Prev</span></li>
          {% endif %}
          <li class="page-item active"><span class="page-link">{{ students.number }} / {{ students.paginator.num_pages }}</span></li>
          {% if students.has_next %}
            <li class="page-item"><a class="page-link" href="?page={{ students.next_page_number }}&{{ query_params }}">Next</a></li>
            <li class="page-item"><a class="page-link" href="?page={{ students.paginator.num_pages }}&{{ query_params }}">&raquo;</a></li>
          {% else %}
            <li class="page-item disabled"><span class="page-link">Next</span></li>
            <li class="page-item disabled"><span class="page-link">&raquo;</span></li>
          {% endif %}
        </ul>
      </nav>
      <div class="remarks-list" id="remarksListContainer">
        <!-- List will be populated by JS -->
      </div>
      {{ students_data|json_script:"student-data" }}
    </div>
    <div class="col-md-8">
      <!-- Empty State -->
      <div id="remarks-empty-state" class="card remarks-card d-flex align-items-center justify-content-center text-center text-muted">
        <div>
          <i class="fas fa-comments fa-4x mb-3 text-secondary"></i>
          <h5>Select a student to view remarks</h5>
          <p class="small">Click on a student from the list to start a conversation</p>
        </div>
      </div>
      
      <!-- Chat Card (Hidden by default) -->
      <div id="remarks-chat-card" class="card remarks-card" style="display: none;">
        <div class="card-body">
          <div class="d-flex align-items-center justify-content-between mb-3">
              <div class="d-flex align-items-center">
                <div class="remarks-avatar me-2" id="remarks-avatar"></div>
                <div>
                  <div id="remarks-title" class="fw-bold"></div>
                  <div class="text-muted" id="remarks-subtitle"></div>
                </div>
              </div>
              <button type="button" class="btn-close" aria-label="Close" id="close-chat-btn"></button>
            </div>
          {% include 'includes/chat_ui.html' with chat_id_prefix='remarks' chat_context='remarks' %}
        </div>
      </div>
    </div>
  </div>
</div>
<script>
  (function(){
    // --- Client-Side Rendering Logic ---
    function getStudentState(unread, isPriority) {
        if (unread > 0) {
            return isPriority ? 'state-priority-unread' : 'state-unread';
        } else {
            return isPriority ? 'state-priority-read' : '';
        }
    }

    function createStudentItemHTML(s) {
      var unread = parseInt(s.unread_count || 0);
      var isPriority = s.is_priority === true || s.is_priority === 'true';
      var pLevel = s.priority_level || 0;
      var name = (s.first_name + ' ' + (s.last_name||'')).trim();
      var initial = s.first_name.charAt(0).toUpperCase();
      var msg = s.last_message || 'No remarks';
      var timeStr = '';
      
      if (s.last_message_time) {
          try {
             var dt = new Date(s.last_message_time);
             var months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
             var dd = ('0' + dt.getDate()).slice(-2);
             var H = dt.getHours();
             var hh12 = H % 12 || 12;
             var ampm = H >= 12 ? 'pm' : 'am';
             var hh = ('0' + hh12).slice(-2);
             var mm = ('0' + dt.getMinutes()).slice(-2);
             timeStr = dd + ' ' + months[dt.getMonth()] + ', ' + hh + ':' + mm + ' ' + ampm;
          } catch(e){}
      }

      var stateClass = getStudentState(unread, isPriority);
      var badgeClass = unread > 0 ? '' : 'd-none';
      
      var starClass = 'd-none';
      if (isPriority) {
          starClass = '';
          if (pLevel === 3) starClass += ' text-danger';
          else if (pLevel === 2) starClass += ' text-warning';
          else starClass += ' text-primary';
      }

      return '<div class="remarks-item ' + stateClass + '" ' +
             'data-student-id="' + s.id + '" ' +
             'data-student-name="' + name + '" ' +
             'data-student-code="' + s.student_id + '" ' +
             'data-unread-count="' + unread + '" ' +
             'data-is-priority="' + (isPriority?'true':'false') + '">' +
          '<div class="remarks-avatar position-relative">' +
              initial +
              '<span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-primary ' + badgeClass + '" ' +
                    'style="font-size: 0.6rem; padding: 0.25em 0.4em;">' +
                unread +
              '</span>' +
          '</div>' +
          '<div class="flex-grow-1 overflow-hidden">' +
            '<div class="d-flex justify-content-between align-items-center mb-1">' +
              '<div class="remarks-name">' +
                  name +
                  '<i class="fas fa-star ms-1 ' + starClass + '" title="Priority"></i>' +
              '</div>' +
              '<div class="remarks-meta">' + s.student_id + '</div>' +
            '</div>' +
            '<div class="d-flex justify-content-between">' +
              '<div class="remarks-preview">' +
                msg +
              '</div>' +
              '<div class="remarks-time">' +
                timeStr +
              '</div>' +
            '</div>' +
          '</div>' +
        '</div>';
    }

    try {
        var dataScript = document.getElementById('student-data');
        if (dataScript) {
            var data = JSON.parse(dataScript.textContent);
            var container = document.getElementById('remarksListContainer');
            if (container) {
                container.innerHTML = '';
                if (!data || !data.length) {
                    container.innerHTML = '<div class="p-3 text-muted">No students found.</div>';
                } else {
                    data.forEach(function(s){
                        container.innerHTML += createStudentItemHTML(s);
                    });
                }
            }
        }
    } catch(e){ console.error("Error rendering list:", e); }
    // -----------------------------------

    var socket = null;
    var listSocket = null;
    var currentId = null;

    function updateListItem(studentId, data){
      var listEl = document.querySelector('#studentRemarks .remarks-list');
      if (!listEl || !studentId) return;
      var sid = String(studentId);
      var item = listEl.querySelector('.remarks-item[data-student-id="'+sid+'"]');
      if (!item) return;

      // 1. Update Message Preview & Time
      if (data.message) {
          var msg = data.message;
          var preview = item.querySelector('.remarks-preview');
          if (preview) { preview.textContent = (msg.message || '').trim(); }
          
          var timeEl = item.querySelector('.remarks-time');
          try {
            if (timeEl) {
              var dt = new Date(msg.created_at);
              var months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
              var dd = ('0' + dt.getDate()).slice(-2);
              var H = dt.getHours();
              var hh12 = H % 12 || 12;
              var ampm = H >= 12 ? 'pm' : 'am';
              var hh = ('0' + hh12).slice(-2);
              var mm = ('0' + dt.getMinutes()).slice(-2);
              timeEl.textContent = dd + ' ' + months[dt.getMonth()] + ', ' + hh + ':' + mm + ' ' + ampm;
            }
          } catch(e){}
          item.setAttribute('data-last-time', msg.created_at || '');
      }

      // 2. Determine New State (Unread & Priority)
      var currentUnread = parseInt(item.getAttribute('data-unread-count') || '0');
      var isPriority = item.getAttribute('data-is-priority') === 'true';

      if (data.is_read_update) {
          currentUnread = 0;
      } else if (typeof data.unread_count !== 'undefined') {
          currentUnread = data.unread_count;
          // If this chat is currently open by THIS user, force unread to 0
          if (currentId && String(currentId) === sid) {
              currentUnread = 0;
          }
      }

      if (typeof data.is_priority !== 'undefined') {
          isPriority = data.is_priority;
      }

      // Update Attributes
      item.setAttribute('data-unread-count', currentUnread);
      item.setAttribute('data-is-priority', isPriority ? 'true' : 'false');

      // Update Badge
      var badge = item.querySelector('.badge');
      if (badge) {
          badge.textContent = currentUnread;
          if (currentUnread > 0) badge.classList.remove('d-none');
          else badge.classList.add('d-none');
      }

      // Apply CSS Classes based on State
      item.classList.remove('state-unread', 'state-priority-unread', 'state-priority-read');
      var newStateClass = getStudentState(currentUnread, isPriority);
      if (newStateClass) {
          item.classList.add(newStateClass);
      }

      // Update Star Icon
      if (typeof data.is_priority !== 'undefined' || typeof data.priority_level !== 'undefined') {
          var star = item.querySelector('.fa-star');
          if (star) {
              if (isPriority) {
                  star.classList.remove('d-none');
                  star.classList.remove('text-danger', 'text-warning', 'text-primary');
                  var level = data.priority_level || 0;
                  // If priority_level is not in update, try to get from previous state or default
                  // But usually update sends both.
                  if (level == 3) star.classList.add('text-danger');
                  else if (level == 2) star.classList.add('text-warning');
                  else star.classList.add('text-primary');
              } else {
                  star.classList.add('d-none');
              }
          }
      }

      // 4. Sorting logic...
      var isPriority = (item.getAttribute('data-is-priority') === 'true');
      var unread = parseInt(item.getAttribute('data-unread-count') || '0');
      var isUnread = unread > 0;
      
      var listChildren = Array.from(listEl.children);
      
      if (isUnread) {
          if (isPriority) {
              // Unread Priority: Top of list
              listEl.insertBefore(item, listEl.firstElementChild);
          } else {
              // Unread Normal: After Unread Priority, Before Read
              // Find first item that is NOT (Unread & Priority)
              var firstNonUnreadPriority = listChildren.find(c => {
                  if (c === item) return false;
                  var cP = c.getAttribute('data-is-priority') === 'true';
                  var cU = parseInt(c.getAttribute('data-unread-count')||'0') > 0;
                  return !(cU && cP);
              });
              
              if (firstNonUnreadPriority) {
                  listEl.insertBefore(item, firstNonUnreadPriority);
              } else {
                  // No non-priority unread items found (all are Unread Priority), append to end?
                  // No, if all are Unread Priority, I go after them.
                  listEl.appendChild(item);
              }
          }
      } else {
          // Read: After All Unread
          // Find first Read item
          var firstRead = listChildren.find(c => {
              if (c === item) return false;
              var cU = parseInt(c.getAttribute('data-unread-count')||'0') > 0;
              return !cU;
          });
          
          if (firstRead) {
              listEl.insertBefore(item, firstRead);
          } else {
              // No read items found (all are unread), append to end
              listEl.appendChild(item);
          }
      }
    }

    function closeChat() {
      if (socket) { try { socket.close(); } catch(e){} socket = null; }
      currentId = null;
      var emptyState = document.getElementById('remarks-empty-state');
      var chatCard = document.getElementById('remarks-chat-card');
      if (chatCard) chatCard.style.display = 'none';
      if (emptyState) emptyState.style.setProperty('display', 'flex', 'important');
    }
    document.getElementById('close-chat-btn').addEventListener('click', closeChat);

    function openChat(id, sname, scode){
      var emptyState = document.getElementById('remarks-empty-state');
      var chatCard = document.getElementById('remarks-chat-card');
      if (emptyState) emptyState.style.setProperty('display', 'none', 'important');
      if (chatCard) chatCard.style.display = 'flex';

      var messagesEl = document.getElementById('remarks-messages');
      var textareaEl = document.getElementById('remarks-textarea');
      var titleEl = document.getElementById('remarks-title');
      var subtitleEl = document.getElementById('remarks-subtitle');
      var avatarEl = document.getElementById('remarks-avatar');
      
      if (socket) { try { socket.close(); } catch(e){} socket = null; }
      currentId = id;
      
      // Clear unread immediately in UI
      updateListItem(id, {is_read_update: true});

      messagesEl.setAttribute('data-student-id', id);
      messagesEl.innerHTML = '';
      messagesEl.setAttribute('data-last-date','');
      avatarEl.textContent = (sname || scode || 'S').trim().charAt(0).toUpperCase();
      titleEl.textContent = sname || ('Student ' + id);
      subtitleEl.textContent = scode ? ('ID: ' + scode) : ('Student ' + id);
      
      var wsScheme = window.location.protocol === "https:" ? "wss" : "ws";
      var hostname = window.location.hostname;
      var port = window.location.port ? (':' + window.location.port) : '';
      var primaryHost = hostname + port;
      var fallbackHost = hostname + ':8000';
      var attemptedFallback = false;
      
      socket = new WebSocket(wsScheme + '://' + primaryHost + '/ws/student/' + id + '/');
      
      socket.onerror = function(){
        if (!attemptedFallback && port && port !== ':8000') {
          attemptedFallback = true;
          try { socket.close(); } catch(e){}
          try {
            socket = new WebSocket(wsScheme + '://' + fallbackHost + '/ws/student/' + id + '/');
            attachHandlers(socket, messagesEl);
          } catch(e){}
        }
      };
      socket.onclose = function(){
        if (!attemptedFallback && port && port !== ':8000') {
          attemptedFallback = true;
          try {
            socket = new WebSocket(wsScheme + '://' + fallbackHost + '/ws/student/' + id + '/');
            attachHandlers(socket, messagesEl);
          } catch(e){}
        }
      };
      
      attachHandlers(socket, messagesEl);

      var sendBtn = document.getElementById('remarks-send');
      if (sendBtn) {
        sendBtn.onclick = function(){
          var text = textareaEl.value.trim();
          if (!text || !socket || socket.readyState !== 1) return;
          var tagVal = document.getElementById('remarks-hashtag-val').value;
          var prVal = document.getElementById('remarks-priority-val').value;
          var payload = { action: 'send', message: text };
          if (tagVal) { payload.hashtag = tagVal; }
          if (prVal) { payload.priority = prVal; }
          try {
            socket.send(JSON.stringify(payload));
            textareaEl.value = '';
            window.resetMsgInputs('remarks');
          } catch(e){}
        };
      }
      if (textareaEl) {
        // Remove old listeners? No, element is persistent. 
        // But if we attach new listener every time openChat is called, it duplicates.
        // Better: attach listener once outside.
        // But textareaEl is constant.
      }
    }

    function attachHandlers(sock, messagesEl){
      sock.onmessage = function(e){
        var data = JSON.parse(e.data);
        if (data.action === 'init' && Array.isArray(data.messages)) {
          messagesEl.innerHTML = '';
          messagesEl.setAttribute('data-last-date','');
          data.messages.forEach(function(m){ renderMessage(messagesEl, m); });
        } else if (data.action === 'new_message' && data.message) {
          renderMessage(messagesEl, data.message);
          updateListItem(currentId, {message: data.message}); 
        } else if (data.action === 'message_updated' && data.message) {
          updateMessageUI(messagesEl, data.message);
          updateListItem(currentId, {message: data.message}); 
        } else if (data.action === 'messages_read' && data.message_ids && data.read_by) {
          updateReadStatusUI(messagesEl, data.message_ids, data.read_by);
        }
      };
    }

    document.addEventListener('click', function(e){
      var item = e.target.closest('.remarks-item');
      if (!item) return;
      var sid = item.getAttribute('data-student-id');
      var sname = item.getAttribute('data-student-name') || '';
      var scode = item.getAttribute('data-student-code') || '';
      openChat(sid, sname, scode);
    });

    // Enter key listener (attached once)
    var textareaEl = document.getElementById('remarks-textarea');
    if (textareaEl) {
       textareaEl.addEventListener('keydown', function(ev){
          if (ev.key === 'Enter' && !ev.shiftKey) {
            ev.preventDefault();
            var text = textareaEl.value.trim();
            if (!text || !socket || socket.readyState !== 1) return;
            var tagVal = document.getElementById('remarks-hashtag-val').value;
            var prVal = document.getElementById('remarks-priority-val').value;
            var payload = { action: 'send', message: text };
            if (tagVal) { payload.hashtag = tagVal; }
            if (prVal) { payload.priority = prVal; }
            try {
              socket.send(JSON.stringify(payload));
              textareaEl.value = '';
              window.resetMsgInputs('remarks');
            } catch(e){}
          }
       });
    }

    window.addEventListener('DOMContentLoaded', function(){
      var sid = "{{ selected_id|default:'' }}";
      var sname = "{{ selected_student.first_name|default:'' }} {{ selected_student.last_name|default:'' }}".trim();
      var scode = "{{ selected_student.student_id|default:'' }}";
      if (sid) { openChat(sid, sname, scode); }
      
      // Connect global list socket
      var wsScheme = window.location.protocol === "https:" ? "wss" : "ws";
      var hostname = window.location.hostname;
      var port = window.location.port ? (':' + window.location.port) : '';
      var url = wsScheme + '://' + hostname + port + '/ws/student/remarks/';
      
      function connectList() {
          listSocket = new WebSocket(url);
          listSocket.onmessage = function(e){
            try {
                var d = JSON.parse(e.data);
                if (d.action === 'remarks_list_update') {
                    updateListItem(d.student_id, d);
                }
            } catch(e){}
          };
          listSocket.onclose = function(){ setTimeout(connectList, 3000); };
      }
      connectList();
    });
    
    // Event listeners for edit and read receipts
    document.addEventListener('conversation:edit_message', function(e){
      if (!socket || socket.readyState !== 1) return;
      var d = e.detail;
      // Ensure we are sending to the correct student socket
      if (d.studentId && currentId && String(d.studentId) !== String(currentId)) return;
      
      try {
         socket.send(JSON.stringify({
           action: 'edit_message',
           message_id: d.messageId,
           new_text: d.newText
         }));
       } catch(err){ console.error(err); }
    });

    document.addEventListener('conversation:mark_read', function(e){
      if (!socket || socket.readyState !== 1) return;
      var d = e.detail;
      if (d.studentId && currentId && String(d.studentId) !== String(currentId)) return;
      
      try {
        socket.send(JSON.stringify({
          action: 'mark_read',
          message_ids: d.messageIds
        }));
      } catch(err){ console.error(err); }
    });
  })();
</script>
{% endblock %}