{% extends "base.html" %}
{% load static %}
{% load custom_filter %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/student_form_modern.css' %}">
<style>
    .accordion-button:not(.collapsed) {
        color: #fff;
        background-color: #007bff;
    }
</style>
{% endblock %}

{% block title %}{{ student.student_id }}-Student Report{% endblock %}

{% block content %}
<div class="student-form-container">
    <div class="form-header">
        <h1>Student Report for {{ student.first_name }} {{ student.last_name }} - {{ student.student_id }}</h1>
        <p class="form-subtitle">Below is the Entire Report of the student.</p>
    </div>

    {% if student.pl_required %}
    <div class="form-section-card">
        <div class="form-section-header">
            <h5 style="color: white;"><i class="fas fa-calendar-alt me-2" style="color: white;"></i>Placement Information - Scheduled Interviews</h5>
        </div>
        <div class="form-section-body">
            <div class="accordion" id="interviewAccordion">
                {% for company_data in company_interview_data %}
                <div class="accordion-item">
                    <h2 class="accordion-header" id="headingCompany{{ forloop.counter }}">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseCompany{{ forloop.counter }}" aria-expanded="false" aria-controls="collapseCompany{{ forloop.counter }}">
                            <div class="container-fluid">
                                <div class="row w-100 ">
                                    <div class="col-5 text-left">
                                        {{ company_data.company_name }} - {{ company_data.company_location }} 
                                    </div>
                                    <div class="col-4">
                                        
                                    </div>
                                    <div class="col-3 text-right">
                                       {{ company_data.total_cycles }} Interview{{ company_data.total_cycles|pluralize }} - {{ company_data.total_rounds }} Round{{ company_data.total_rounds|pluralize }}
                                    </div>
                                </div>
                            </div>
                        </button>
                    </h2>
                    <div id="collapseCompany{{ forloop.counter }}" class="accordion-collapse collapse" aria-labelledby="headingCompany{{ forloop.counter }}" data-bs-parent="#interviewAccordion">
                        <div class="accordion-body">
                            {% for cycle_number, interviews in company_data.cycles.items %}
                            <div class="mb-3">
                                <h5>Interview {{ cycle_number }}</h5>
                                {% for interview in interviews %}
                                <div class="ps-3">
                                    <h6>Round {{ interview.round_number }} - {{ interview.interview_round|capfirst }}</h6>
                                    <div style="display: flex; justify-content: space-between;">
                                        <p><strong>Date:</strong> {{ interview.interview_date }} | <strong>Time:</strong> {{ interview.interview_time }} | <strong>Location:</strong> {{ interview.location|capfirst }}{% if interview.location == 'others' %} ({{ interview.other_location }}){% endif %} | <strong>Venue:</strong> {{ interview.venue|capfirst }}</p>
                                        <p><strong>Scheduled By:</strong> <strong style="color: #074383;">{{ interview.created_by.name }}</strong> at {{ interview.created_at }}</p>
                                    </div>
                                    <p><strong>Status:</strong>
                                        {% for status in interview.student_status.all %}
                                            {% if status.student.id == student.id %}
                                                {{ status.get_status_display }}
                                                {% if status.status == 'rejected' or status.status == 'not_attended' and status.reason %}
                                                    <br><strong>Reason:</strong> {{ status.reason }}
                                                {% endif %}
                                                {% if status.status == 'placed' and status.offer_letter %}
                                                    <br><a href="{{ status.offer_letter.url }}" class="view-link" target="_blank">View Offer Letter</a>
                                                {% endif %}
                                            {% endif %}
                                        {% endfor %}
                                    </p>
                                </div>
                                {% endfor %}
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                {% empty %}
                <p>No interviews scheduled for this student.</p>
                {% endfor %}
            </div>
        </div>
    </div>
    {% else %}
    <div class="form-section-card">
        <div class="form-section-header">
            <h5 style="color: white;"><i class="fas fa-info-circle me-2" style="color: white;"></i>Placement Information</h5>
        </div>
        <div class="form-section-body">
            <p>This student does not require placement assistance.</p>
        </div>
    </div>
    {% endif %}
    
    <!-- Batch History Section -->
    <div class="form-section-card">
        <div class="form-section-header">
            <h5 style="color: white;"><i class="fas fa-history me-2" style="color: white;"></i>Batch History</h5>
        </div>
        <div class="form-section-body">
            <div class="accordion" id="batchHistoryAccordion">
                <div class="accordion-item">
                    <h2 class="accordion-header" id="headingCurrentBatches">
                        <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseCurrentBatches" aria-expanded="true" aria-controls="collapseCurrentBatches">
                            Current Batches
                        </button>
                    </h2>
                    <div id="collapseCurrentBatches" class="accordion-collapse collapse show" aria-labelledby="headingCurrentBatches" data-bs-parent="#batchHistoryAccordion">
                        <div class="accordion-body">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr class="table-light">
                                            <th>Batch ID</th>
                                            <th>Course</th>
                                            <th>Trainer</th>
                                            <th>Slot Time</th>
                                            <th>Activated On</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% if batch_history.current_batch %}
                                        <tr>
                                            <td><strong>{{ batch_history.current_batch.batch_id }}</strong></td>
                                            <td>{{ batch_history.current_batch.course }}</td>
                                            <td>{{ batch_history.current_batch.trainer }}</td>
                                            <td>{{ batch_history.current_batch.slot_time }}</td>
                                            <td>{{ batch_history.current_batch.activated_at|date:"d M Y" }}</td>
                                            <td><span class="badge bg-success">{{ batch_history.current_batch.status }}</span></td>
                                        </tr>
                                        {% else %}
                                        <tr>
                                            <td colspan="6" class="text-center text-muted">No current batch found</td>
                                        </tr>
                                        {% endif %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="accordion-item">
                    <h2 class="accordion-header" id="headingPreviousBatches">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapsePreviousBatches" aria-expanded="false" aria-controls="collapsePreviousBatches">
                            Previous Batches
                        </button>
                    </h2>
                    <div id="collapsePreviousBatches" class="accordion-collapse collapse" aria-labelledby="headingPreviousBatches" data-bs-parent="#batchHistoryAccordion">
                        <div class="accordion-body">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr class="table-light">
                                            <th>Batch ID</th>
                                            <th>Course</th>
                                            <th>Trainer</th>
                                            <th>Slot Time</th>
                                            <th>Deactivated On</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for batch in batch_history.batch_history %}
                                        <tr>
                                            <td><strong>{{ batch.batch_id }}</strong></td>
                                            <td>{{ batch.course }}</td>
                                            <td>{{ batch.trainer }}</td>
                                            <td>{{ batch.slot_time }}</td>
                                            <td>{{ batch.deactivated_at|date:"d M Y" }}</td>
                                            <td><span class="badge bg-secondary">{{ batch.status }}</span></td>
                                        </tr>
                                        {% empty %}
                                        <tr>
                                            <td colspan="6" class="text-center text-muted">No previous batches found</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="accordion-item">
                    <h2 class="accordion-header" id="headingTransactions">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTransactions" aria-expanded="false" aria-controls="collapseTransactions">
                            Batch Transactions
                        </button>
                    </h2>
                    <div id="collapseTransactions" class="accordion-collapse collapse" aria-labelledby="headingTransactions" data-bs-parent="#batchHistoryAccordion">
                        <div class="accordion-body">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr class="table-light">
                                            <th>Timestamp</th>
                                            <th>Batch</th>
                                            <th>Type</th>
                                            <th>Details</th>
                                            <th>User</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for transaction in batch_history.transactions %}
                                        <tr>
                                            <td>{{ transaction.timestamp|date:"d M Y, H:i" }}</td>
                                            <td><strong>{{ transaction.batch.batch_id }}</strong></td>
                                            <td>
                                                <span class="badge {% if 'ADD' in transaction.transaction_type %}bg-success{% elif 'REMOVE' in transaction.transaction_type %}bg-danger{% elif 'TRANSFER' in transaction.transaction_type %}bg-warning text-dark{% else %}bg-info{% endif %}">
                                                    {{ transaction.get_transaction_type_display }}
                                                </span>
                                            </td>
                                            <td class="small">
                                                {% for key, value in transaction.details.items %}
                                                    <strong>{{ key|title|replace:"_| " }}:</strong> {{ value }}<br>
                                                {% endfor %}
                                            </td>
                                            <td>{{ transaction.user.username }}</td>
                                        </tr>
                                        {% empty %}
                                        <tr>
                                            <td colspan="5" class="text-center text-muted">No transactions found</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}