{% extends "base.html" %}
{% load custom_filter %}

{% block title %}Requests Management{% endblock %}

{% block content %}
<style>
    .card {
        border: none;
        box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    .card-header {
        background-color: #fff;
        border-bottom: 1px solid #eee;
        padding: 15px 20px;
    }
    .form-select, .form-control {
        border-radius: 4px;
        border: 1px solid #ced4da;
        padding: 8px 12px;
        height: 38px;
    }
    .btn-primary {
        background-color: #0d6efd;
        border-color: #0d6efd;
    }
    .btn-primary:hover {
        background-color: #0b5ed7;
        border-color: #0a58ca;
    }
    .table th {
        font-weight: 600;
        color: #495057;
        border-top: none;
    }
    .table td {
        vertical-align: middle;
    }
    .badge {
        padding: 6px 10px;
        font-weight: 500;
        border-radius: 4px;
    }
    .badge-rejected {
        background-color: #dc3545;
        color: white;
    }
    .badge-approved {
        background-color: #28a745;
        color: white;
    }
    .badge-pending {
        background-color: #ffc107;
        color: #212529;
    }
    .request-type-transfer {
        border-left: 4px solid #007bff;
    }
    .request-type-handover {
        border-left: 4px solid #6f42c1;
    }
    .btn-view-details {
        background-color: #0d6efd;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 4px;
        display: inline-block;
    }
    .btn-view-details:hover {
        background-color: #0b5ed7;
        color: white;
    }
    .student-transfer-badge {
        background-color: #007bff;
        color: white;
        padding: 5px 10px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: 500;
    }
</style>

<h2 class="mb-4">Requests Management</h2>

<div class="row mb-4">
    <div class="col-md-4">
        <div class="form-group">
            <label for="requestTypeFilter">Request Type</label>
            <select class="form-select" id="requestTypeFilter">
                <option value="all" selected>All Requests</option>
                <option value="transfer">Student Transfer</option>
                <option value="handover">Trainer Handover</option>
            </select>
        </div>
    </div>
    <div class="col-md-4">
        <div class="form-group">
            <label for="statusFilter">Status</label>
            <select class="form-select" id="statusFilter">
                <option value="all" selected>All Status</option>
                <option value="pending">Pending</option>
                <option value="approved">Approved</option>
                <option value="rejected">Rejected</option>
            </select>
        </div>
    </div>
    <div class="col-md-4">
        <div class="form-group">
            <label for="dateFilter">Date Range</label>
            <input type="text" class="form-control" id="dateFilter" placeholder="mm/dd/yyyy">
        </div>
    </div>
</div>

<div class="row mb-3">
    <div class="col-md-12 text-end">
        <button class="btn btn-primary" id="applyFilters">Apply Filters</button>
        <button class="btn btn-secondary ms-2" id="resetFilters">Reset</button>
    </div>
</div>

<div class="table-responsive">
    <table class="table table-striped">
        <thead>
            <tr>
                <th>Type</th>
                <th>Request ID</th>
                <th>Requested By</th>
                <th>Request Date</th>
                <th>Details</th>
                <th>Status</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for request_item in requests %}
            <tr>
                <td>
                    {% if request_item.request_type == 'transfer' %}
                    <span class="student-transfer-badge">Student Transfer</span>
                    {% else %}
                    <span class="badge bg-purple">Trainer Handover</span>
                    {% endif %}
                </td>
                <td>{{ request_item.id }}</td>
                <td>{{ request_item.requested_by }}</td>
                <td>{{ request_item.created_at|date:"d M Y" }}</td>
                <td>
                    {% if request_item.request_type == 'transfer' %}
                    <strong>Student:</strong> {{ request_item.student.name }}<br>
                    <strong>From:</strong> {{ request_item.from_batch }}<br>
                    <strong>To:</strong> {{ request_item.to_batch }}
                    {% else %}
                    <strong>Batch:</strong> {{ request_item.batch }}<br>
                    <strong>From:</strong> {{ request_item.from_trainer }}<br>
                    <strong>To:</strong> {{ request_item.to_trainer }}
                    {% endif %}
                </td>
                <td>
                    {% if request_item.status == 'pending' %}
                    <span class="badge badge-pending">Pending</span>
                    {% elif request_item.status == 'approved' %}
                    <span class="badge badge-approved">Approved</span>
                    {% else %}
                    <span class="badge badge-rejected">Rejected</span>
                    {% endif %}
                </td>
                <td>
                    <div class="btn-group" role="group">
                        <button class="btn btn-sm btn-primary view-details-btn" 
                            data-id="{{ request_item.id }}" 
                            data-type="{{ request_item.request_type }}">
                            <i class="fas fa-eye"></i> View
                        </button>
                        {% if request_item.status == 'pending' %}
                        <button class="btn btn-sm btn-success approve-btn" 
                            data-id="{{ request_item.id }}" 
                            data-type="{{ request_item.request_type }}"
                            data-bs-toggle="modal" 
                            data-bs-target="#approveModal">
                            <i class="fas fa-check"></i> Approve
                        </button>
                        <button class="btn btn-sm btn-danger reject-btn" 
                            data-id="{{ request_item.id }}" 
                            data-type="{{ request_item.request_type }}"
                            data-bs-toggle="modal" 
                            data-bs-target="#rejectModal">
                            <i class="fas fa-times"></i> Reject
                        </button>
                        {% endif %}
                    </div>
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="7" class="text-center">No requests found</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Pagination -->
{% if requests.has_other_pages %}
<nav aria-label="Page navigation">
    <ul class="pagination justify-content-center mt-4">
        {% if requests.has_previous %}
        <li class="page-item">
            <a class="page-link" href="?page={{ requests.previous_page_number }}" aria-label="Previous">
                <span aria-hidden="true">&laquo;</span>
            </a>
        </li>
        {% else %}
        <li class="page-item disabled">
            <span class="page-link" aria-hidden="true">&laquo;</span>
        </li>
        {% endif %}

        {% for i in requests.paginator.page_range %}
        {% if requests.number == i %}
        <li class="page-item active"><span class="page-link">{{ i }}</span></li>
        {% else %}
        <li class="page-item"><a class="page-link" href="?page={{ i }}">{{ i }}</a></li>
        {% endif %}
        {% endfor %}

        {% if requests.has_next %}
        <li class="page-item">
            <a class="page-link" href="?page={{ requests.next_page_number }}" aria-label="Next">
                <span aria-hidden="true">&raquo;</span>
            </a>
        </li>
        {% else %}
        <li class="page-item disabled">
            <span class="page-link" aria-hidden="true">&raquo;</span>
        </li>
        {% endif %}
    </ul>
</nav>
{% endif %}

<!-- Approve Modal -->
<div class="modal fade" id="approveModal" tabindex="-1" aria-labelledby="approveModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="approveModalLabel">Approve Request</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="approveForm">
                {% csrf_token %}
                <div class="modal-body">
                    <p>Are you sure you want to approve this request?</p>
                    <div id="approveDetails"></div>
                    <input type="hidden" id="approveRequestId" name="request_id">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success">Approve</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Reject Modal -->
<div class="modal fade" id="rejectModal" tabindex="-1" aria-labelledby="rejectModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="rejectModalLabel">Reject Request</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="rejectForm">
                {% csrf_token %}
                <div class="modal-body">
                    <p>Are you sure you want to reject this request?</p>
                    <div id="rejectDetails"></div>
                    <div class="mb-3">
                        <label for="rejectReason" class="form-label">Reason for Rejection</label>
                        <textarea class="form-control" id="rejectReason" name="reason" rows="3" required></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger">Reject</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- View Details Modal -->
<div class="modal fade" id="detailsModal" tabindex="-1" aria-labelledby="detailsModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="detailsModalLabel">Request Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Content will be loaded dynamically -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<script>
    $(document).ready(function() {
        // Initialize date picker
        $('#dateFilter').datepicker({
            format: 'mm/dd/yyyy',
            autoclose: true,
            todayHighlight: true,
            clearBtn: true
        });

        // Apply filters
        $('#applyFilters').click(function() {
            applyFilters();
        });

        // Reset filters
        $('#resetFilters').click(function() {
            $('#requestTypeFilter').val('all');
            $('#statusFilter').val('all');
            $('#dateFilter').val('');
            applyFilters();
        });
        
        // Handle approve button click
        $('.approve-btn').click(function() {
            let requestId = $(this).data('id');
            $('#approveRequestId').val(requestId);
            $('#approveModal').modal('show');
        });

        // Handle reject button click
        $('.reject-btn').click(function() {
            let requestId = $(this).data('id');
            $('#rejectRequestId').val(requestId);
            $('#rejectModal').modal('show');
        });
        
        // Handle approve form submission
        $('#approveForm').submit(function(e) {
            e.preventDefault();
            var requestId = $('#approveRequestId').val();
            
            $.ajax({
                url: "{% url 'batchdb:approve_request' request_id=0 %}".replace('0', requestId),
                type: 'POST',
                data: $(this).serialize(),
                success: function(response) {
                    $('#approveModal').modal('hide');
                    alert('Request approved successfully');
                    location.reload();
                },
                error: function(xhr) {
                    var errorMsg = 'An error occurred';
                    if (xhr.responseJSON && xhr.responseJSON.error) {
                        errorMsg = xhr.responseJSON.error;
                    }
                    alert('Error: ' + errorMsg);
                }
            });
        });

        // Handle reject form submission
        $('#rejectForm').submit(function(e) {
            e.preventDefault();
            var requestId = $('#rejectRequestId').val();
            
            $.ajax({
                url: "{% url 'batchdb:reject_request' request_id=0 %}".replace('0', requestId),
                type: 'POST',
                data: $(this).serialize(),
                success: function(response) {
                    $('#rejectModal').modal('hide');
                    alert('Request rejected successfully');
                    location.reload();
                },
                error: function(xhr) {
                    var errorMsg = 'An error occurred';
                    if (xhr.responseJSON && xhr.responseJSON.error) {
                        errorMsg = xhr.responseJSON.error;
                    }
                    alert('Error: ' + errorMsg);
                }
            });
        });
        
        // Handle view details
        $('.view-details-btn').click(function() {
            let requestId = $(this).data('id');
            
            // Load request details via AJAX
            $.ajax({
                url: "{% url 'batchdb:request_details' request_id=0 %}".replace('0', requestId),
                type: 'GET',
                success: function(data) {
                    // Populate modal with request details
                    $('#viewDetailsModal .modal-title').text('Request Details #' + requestId);
                    
                    // Create HTML content for request details
                    let html = '<div class="request-details">';
                    html += '<p><strong>Type:</strong> ' + data.type + '</p>';
                    html += '<p><strong>Status:</strong> ' + data.status + '</p>';
                    html += '<p><strong>Date:</strong> ' + data.date + '</p>';
                    html += '<p><strong>Requested By:</strong> ' + data.requested_by + '</p>';
                    
                    // Type-specific details
                    if (data.type === 'Student Transfer') {
                        html += '<p><strong>Student:</strong> ' + data.student + '</p>';
                        html += '<p><strong>From:</strong> ' + data.from_batch + '</p>';
                        html += '<p><strong>To:</strong> ' + data.to_batch + '</p>';
                    } else if (data.type === 'Batch Transfer') {
                        html += '<p><strong>Batch:</strong> ' + data.batch + '</p>';
                        html += '<p><strong>From:</strong> ' + data.from_teacher + '</p>';
                        html += '<p><strong>To:</strong> ' + data.to_teacher + '</p>';
                    }
                    
                    // Add rejection reason if rejected
                    if (data.status === 'Rejected' && data.rejection_reason) {
                        html += '<p><strong>Rejection Reason:</strong> ' + data.rejection_reason + '</p>';
                    }
                    
                    html += '</div>';
                    $('#viewDetailsModal .modal-body').html(html);
                    $('#viewDetailsModal').modal('show');
                },
                error: function() {
                    alert('Error loading request details');
                }
            });
        });
                    html += '<p><strong>Request Type:</strong> ' + data.request_type + '</p>';
                    html += '<p><strong>Status:</strong> <span class="badge ' + (data.status === 'pending' ? 'bg-warning' : (data.status === 'approved' ? 'bg-success' : 'bg-danger')) + '">' + data.status + '</span></p>';
                    html += '<p><strong>Requested By:</strong> ' + data.requested_by + '</p>';
                    html += '<p><strong>Created At:</strong> ' + data.created_at + '</p>';
                    
                    // Type-specific details
                    if (data.request_type === 'transfer') {
                        html += '<h5 class="mt-3">Transfer Details</h5>';
                        html += '<p><strong>Student:</strong> ' + data.student_name + '</p>';
                        html += '<p><strong>From Batch:</strong> ' + data.from_batch + '</p>';
                        html += '<p><strong>To Batch:</strong> ' + data.to_batch + '</p>';
                    } else if (data.request_type === 'handover') {
                        html += '<h5 class="mt-3">Handover Details</h5>';
                        html += '<p><strong>Batch:</strong> ' + data.batch + '</p>';
                        html += '<p><strong>From Trainer:</strong> ' + data.from_trainer + '</p>';
                        html += '<p><strong>To Trainer:</strong> ' + data.to_trainer + '</p>';
                    }
                    
                    // Status-specific details
                    if (data.status === 'approved') {
                        html += '<h5 class="mt-3">Approval Details</h5>';
                        html += '<p><strong>Approved By:</strong> ' + data.approved_by + '</p>';
                        html += '<p><strong>Approved At:</strong> ' + data.approved_at + '</p>';
                    } else if (data.status === 'rejected') {
                        html += '<h5 class="mt-3">Rejection Details</h5>';
                        html += '<p><strong>Rejected By:</strong> ' + data.rejected_by + '</p>';
                        html += '<p><strong>Rejected At:</strong> ' + data.rejected_at + '</p>';
                        html += '<p><strong>Reason:</strong> ' + (data.reject_reason || 'No reason provided') + '</p>';
                    }
                    
                    html += '</div>';
                    $('#detailsModal .modal-body').html(html);
                    $('#detailsModal').modal('show');
                },
                error: function() {
                    alert('Error loading request details');
                }
            });
        });

        function applyFilters() {
            let requestType = $('#requestTypeFilter').val();
            let status = $('#statusFilter').val();
            let date = $('#dateFilter').val();
            
            let url = window.location.pathname + '?';
            if (requestType !== 'all') {
                url += 'type=' + requestType + '&';
            }
            if (status !== 'all') {
                url += 'status=' + status + '&';
            }
            if (date) {
                url += 'date=' + date + '&';
            }
            
            window.location.href = url;
        }

        // Handle approve button click
        $('.approve-btn').click(function() {
            let requestId = $(this).data('id');
            let requestType = $(this).data('type');
            
            // Get request details and populate modal
            $.ajax({
                url: '/batchdb/requests/' + requestId + '/details/',
                type: 'GET',
                success: function(data) {
                    $('#approveDetails').html(formatRequestDetails(data, requestType));
                    $('#confirmApprove').data('id', requestId);
                },
                error: function(xhr) {
                    alert('Error loading request details');
                }
            });
        });

        // Handle reject button click
        $('.reject-btn').click(function() {
            let requestId = $(this).data('id');
            let requestType = $(this).data('type');
            
            // Get request details and populate modal
            $.ajax({
                url: '/batchdb/requests/' + requestId + '/details/',
                type: 'GET',
                success: function(data) {
                    $('#rejectDetails').html(formatRequestDetails(data, requestType));
                    $('#confirmReject').data('id', requestId);
                },
                error: function(xhr) {
                    alert('Error loading request details');
                }
            });
        });

        // Handle view details button click
        $('.view-details-btn').click(function() {
            let requestId = $(this).data('id');
            let requestType = $(this).data('type');
            
            // Show modal
            $('#viewDetailsModal').modal('show');
            
            // Get request details
            $.ajax({
                url: `/batchdb/api/${requestType === 'transfer' ? 'transfer-requests' : 'handover-requests'}/${requestId}/`,
                type: 'GET',
                success: function(data) {
                    $('#requestDetailsContent').html(formatFullRequestDetails(data));
                },
                error: function(xhr) {
                    $('#requestDetailsContent').html('<div class="alert alert-danger">Error loading request details</div>');
                }
            });
        });

        // Handle confirm approve
        $('#confirmApprove').click(function() {
            let requestId = $(this).data('id');
            let requestType = $(this).data('type');
            
            $.ajax({
                url: `/batchdb/api/${requestType === 'transfer' ? 'transfer-requests' : 'handover-requests'}/${requestId}/approve/`,
                type: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                },
                success: function(data) {
                    $('#approveModal').modal('hide');
                    showAlert('Request approved successfully', 'success');
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);
                },
                error: function(xhr) {
                    $('#approveModal').modal('hide');
                    showAlert(xhr.responseJSON?.message || 'Error approving request', 'danger');
                }
            });
        });

        // Handle confirm reject
        $('#confirmReject').click(function() {
            let requestId = $(this).data('id');
            let requestType = $(this).data('type');
            let reason = $('#rejectReason').val();
            
            if (!reason) {
                alert('Please provide a reason for rejection');
                return;
            }
            
            $.ajax({
                url: `/batchdb/api/${requestType === 'transfer' ? 'transfer-requests' : 'handover-requests'}/${requestId}/reject/`,
                type: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                },
                data: {
                    reason: reason
                },
                success: function(data) {
                    $('#rejectModal').modal('hide');
                    showAlert('Request rejected successfully', 'success');
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);
                },
                error: function(xhr) {
                    $('#rejectModal').modal('hide');
                    showAlert(xhr.responseJSON?.message || 'Error rejecting request', 'danger');
                }
            });
        });

        // Helper function to format request details
        function formatRequestDetails(data, type) {
            let html = '<div class="mt-3">';
            
            if (type === 'transfer') {
                html += '<p><strong>Student:</strong> ' + data.student_name + '</p>';
                html += '<p><strong>From Batch:</strong> ' + data.from_batch + '</p>';
                html += '<p><strong>To Batch:</strong> ' + data.to_batch + '</p>';
            } else {
                html += '<p><strong>Batch:</strong> ' + data.batch + '</p>';
                html += '<p><strong>From Trainer:</strong> ' + data.from_trainer + '</p>';
                html += '<p><strong>To Trainer:</strong> ' + data.to_trainer + '</p>';
            }
            
            html += '<p><strong>Requested By:</strong> ' + data.requested_by + '</p>';
            html += '<p><strong>Request Date:</strong> ' + data.created_at + '</p>';
            
            html += '</div>';
            return html;
        }

        // Helper function to format full request details
        function formatFullRequestDetails(data) {
            let html = '<div class="container-fluid">';
            
            // Status badge
            let statusClass = '';
            if (data.status === 'approved') {
                statusClass = 'badge-approved';
            } else if (data.status === 'rejected') {
                statusClass = 'badge-rejected';
            } else {
                statusClass = 'badge-pending';
            }
            
            html += '<div class="row mb-3">';
            html += '<div class="col-md-12">';
            html += '<h6>Status: <span class="badge ' + statusClass + '">' + data.status.toUpperCase() + '</span></h6>';
            html += '</div>';
            html += '</div>';
            
            // Request details
            html += '<div class="row">';
            html += '<div class="col-md-6">';
            html += '<div class="card mb-3">';
            html += '<div class="card-header">Request Information</div>';
            html += '<div class="card-body">';
            html += '<p><strong>Request ID:</strong> ' + data.id + '</p>';
            html += '<p><strong>Request Type:</strong> ' + (data.request_type === 'transfer' ? 'Student Transfer' : 'Trainer Handover') + '</p>';
            html += '<p><strong>Requested By:</strong> ' + data.requested_by + '</p>';
            html += '<p><strong>Request Date:</strong> ' + data.created_at + '</p>';
            
            if (data.status === 'approved') {
                html += '<p><strong>Approved By:</strong> ' + data.approved_by + '</p>';
                html += '<p><strong>Approved Date:</strong> ' + data.approved_at + '</p>';
            } else if (data.status === 'rejected') {
                html += '<p><strong>Rejected By:</strong> ' + data.rejected_by + '</p>';
                html += '<p><strong>Rejected Date:</strong> ' + data.rejected_at + '</p>';
                if (data.reject_reason) {
                    html += '<p><strong>Rejection Reason:</strong> ' + data.reject_reason + '</p>';
                }
            }
            
            html += '</div>';
            html += '</div>';
            html += '</div>';
            
            // Transfer/Handover details
            html += '<div class="col-md-6">';
            html += '<div class="card">';
            html += '<div class="card-header">' + (data.request_type === 'transfer' ? 'Transfer' : 'Handover') + ' Details</div>';
            html += '<div class="card-body">';
            
            if (data.request_type === 'transfer') {
                html += '<p><strong>Student:</strong> ' + data.student_name + '</p>';
                html += '<p><strong>From Batch:</strong> ' + data.from_batch + '</p>';
                html += '<p><strong>To Batch:</strong> ' + data.to_batch + '</p>';
                if (data.transfer_reason) {
                    html += '<p><strong>Transfer Reason:</strong> ' + data.transfer_reason + '</p>';
                }
            } else {
                html += '<p><strong>Batch:</strong> ' + data.batch + '</p>';
                html += '<p><strong>From Trainer:</strong> ' + data.from_trainer + '</p>';
                html += '<p><strong>To Trainer:</strong> ' + data.to_trainer + '</p>';
                if (data.handover_reason) {
                    html += '<p><strong>Handover Reason:</strong> ' + data.handover_reason + '</p>';
                }
            }
            
            html += '</div>';
            html += '</div>';
            html += '</div>';
            html += '</div>';
            
            html += '</div>';
            return html;
        }

        // Helper function to get CSRF token
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    });
</script>

<!-- Approve Modal -->
<div class="modal fade" id="approveModal" tabindex="-1" aria-labelledby="approveModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="approveModalLabel">Approve Request</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to approve this request?</p>
                <div id="approveDetails"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" id="confirmApprove">Approve</button>
            </div>
        </div>
    </div>
</div>

<!-- Reject Modal -->
<div class="modal fade" id="rejectModal" tabindex="-1" aria-labelledby="rejectModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="rejectModalLabel">Reject Request</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to reject this request?</p>
                <div id="rejectDetails"></div>
                <div class="form-group mt-3">
                    <label for="rejectReason">Reason for Rejection</label>
                    <textarea class="form-control" id="rejectReason" rows="3" required></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmReject">Reject</button>
            </div>
        </div>
    </div>
</div>

<!-- View Details Modal -->
<div class="modal fade" id="viewDetailsModal" tabindex="-1" aria-labelledby="viewDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="viewDetailsModalLabel">Request Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="requestDetailsContent"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<script>
    $(document).ready(function() {
        // Filter functionality
        $('#applyFilters').on('click', function() {
            applyFilters();
        });

        $('#resetFilters').on('click', function() {
            $('#requestTypeFilter').val('all');
            $('#statusFilter').val('all');
            $('#dateFilter').val('');
            applyFilters();
        });

        function applyFilters() {
            const requestType = $('#requestTypeFilter').val();
            const status = $('#statusFilter').val();
            const date = $('#dateFilter').val();
            
            let url = window.location.pathname + '?';
            if (requestType !== 'all') url += `request_type=${requestType}&`;
            if (status !== 'all') url += `status=${status}&`;
            if (date) url += `date=${date}&`;
            
            window.location.href = url;
        }

        // Approve request
        $('.approve-btn').on('click', function() {
            const requestId = $(this).data('id');
            const requestType = $(this).data('type');
            
            // Populate modal with request details
            $('#approveDetails').html('Loading details...');
            
            // Fetch request details
            $.ajax({
                url: `/batchdb/api/${requestType === 'transfer' ? 'transfer-requests' : 'handover-requests'}/${requestId}/`,
                method: 'GET',
                success: function(data) {
                    let detailsHtml = '';
                    if (requestType === 'transfer') {
                        detailsHtml = `
                            <p><strong>Student:</strong> ${data.student.name}</p>
                            <p><strong>From Batch:</strong> ${data.from_batch.batch_id}</p>
                            <p><strong>To Batch:</strong> ${data.to_batch.batch_id}</p>
                        `;
                    } else {
                        detailsHtml = `
                            <p><strong>Batch:</strong> ${data.batch.batch_id}</p>
                            <p><strong>From Trainer:</strong> ${data.from_trainer.name}</p>
                            <p><strong>To Trainer:</strong> ${data.to_trainer.name}</p>
                        `;
                    }
                    $('#approveDetails').html(detailsHtml);
                },
                error: function() {
                    $('#approveDetails').html('<p class="text-danger">Error loading details</p>');
                }
            });
            
            // Set up confirm button
            $('#confirmApprove').data('id', requestId);
            $('#confirmApprove').data('type', requestType);
        });

        $('#confirmApprove').on('click', function() {
            const requestId = $(this).data('id');
            const requestType = $(this).data('type');
            
            $.ajax({
                url: `/batchdb/api/${requestType === 'transfer' ? 'transfer-requests' : 'handover-requests'}/${requestId}/approve/`,
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                },
                success: function() {
                    $('#approveModal').modal('hide');
                    showAlert('Request approved successfully', 'success');
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);
                },
                error: function(xhr) {
                    $('#approveModal').modal('hide');
                    showAlert(xhr.responseJSON?.message || 'Error approving request', 'danger');
                }
            });
        });

        // Reject request
        $('.reject-btn').on('click', function() {
            const requestId = $(this).data('id');
            const requestType = $(this).data('type');
            
            // Populate modal with request details
            $('#rejectDetails').html('Loading details...');
            
            // Fetch request details
            $.ajax({
                url: `/batchdb/api/${requestType === 'transfer' ? 'transfer-requests' : 'handover-requests'}/${requestId}/`,
                method: 'GET',
                success: function(data) {
                    let detailsHtml = '';
                    if (requestType === 'transfer') {
                        detailsHtml = `
                            <p><strong>Student:</strong> ${data.student.name}</p>
                            <p><strong>From Batch:</strong> ${data.from_batch.batch_id}</p>
                            <p><strong>To Batch:</strong> ${data.to_batch.batch_id}</p>
                        `;
                    } else {
                        detailsHtml = `
                            <p><strong>Batch:</strong> ${data.batch.batch_id}</p>
                            <p><strong>From Trainer:</strong> ${data.from_trainer.name}</p>
                            <p><strong>To Trainer:</strong> ${data.to_trainer.name}</p>
                        `;
                    }
                    $('#rejectDetails').html(detailsHtml);
                },
                error: function() {
                    $('#rejectDetails').html('<p class="text-danger">Error loading details</p>');
                }
            });
            
            // Set up confirm button
            $('#confirmReject').data('id', requestId);
            $('#confirmReject').data('type', requestType);
        });

        $('#confirmReject').on('click', function() {
            const requestId = $(this).data('id');
            const requestType = $(this).data('type');
            const reason = $('#rejectReason').val();
            
            if (!reason) {
                alert('Please provide a reason for rejection');
                return;
            }
            
            $.ajax({
                url: `/batchdb/api/${requestType === 'transfer' ? 'transfer-requests' : 'handover-requests'}/${requestId}/reject/`,
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                },
                data: {
                    reason: reason
                },
                success: function() {
                    $('#rejectModal').modal('hide');
                    showAlert('Request rejected successfully', 'success');
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);
                },
                error: function(xhr) {
                    $('#rejectModal').modal('hide');
                    showAlert(xhr.responseJSON?.message || 'Error rejecting request', 'danger');
                }
            });
        });

        // View details
        $('.view-details-btn').on('click', function() {
            const requestId = $(this).data('id');
            const requestType = $(this).data('type');
            
            // Fetch request details
            $.ajax({
                url: `/batchdb/api/${requestType === 'transfer' ? 'transfer-requests' : 'handover-requests'}/${requestId}/`,
                method: 'GET',
                success: function(data) {
                    let detailsHtml = `
                        <div class="card">
                            <div class="card-header">
                                <h5>${requestType === 'transfer' ? 'Student Transfer' : 'Trainer Handover'} Request #${data.id}</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                    `;
                    
                    if (requestType === 'transfer') {
                        detailsHtml += `
                            <p><strong>Student:</strong> ${data.student.name}</p>
                            <p><strong>From Batch:</strong> ${data.from_batch.batch_id}</p>
                            <p><strong>To Batch:</strong> ${data.to_batch.batch_id}</p>
                        `;
                    } else {
                        detailsHtml += `
                            <p><strong>Batch:</strong> ${data.batch.batch_id}</p>
                            <p><strong>From Trainer:</strong> ${data.from_trainer.name}</p>
                            <p><strong>To Trainer:</strong> ${data.to_trainer.name}</p>
                            <p><strong>Handover Date:</strong> ${data.handover_date || 'Not specified'}</p>
                        `;
                    }
                    
                    detailsHtml += `
                                    </div>
                                    <div class="col-md-6">
                                        <p><strong>Requested By:</strong> ${data.requested_by.name || data.requested_by}</p>
                                        <p><strong>Request Date:</strong> ${new Date(data.created_at).toLocaleDateString()}</p>
                                        <p><strong>Status:</strong> 
                                            <span class="badge badge-${data.status === 'approved' ? 'approved' : data.status === 'rejected' ? 'rejected' : 'pending'}">
                                                ${data.status.charAt(0).toUpperCase() + data.status.slice(1)}
                                            </span>
                                        </p>
                    `;
                    
                    if (data.status === 'rejected' && data.rejection_reason) {
                        detailsHtml += `
                            <p><strong>Rejection Reason:</strong> ${data.rejection_reason}</p>
                        `;
                    }
                    
                    detailsHtml += `
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    $('#requestDetailsContent').html(detailsHtml);
                    $('#viewDetailsModal').modal('show');
                },
                error: function() {
                    showAlert('Error loading request details', 'danger');
                }
            });
        });

        // Helper functions
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        function showAlert(message, type) {
            const alertHtml = `
                <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                    <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'danger' ? 'fa-times-circle' : 'fa-info-circle'} me-2"></i>
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            `;
            
            $('.messages').html(alertHtml);
            $('html, body').animate({ scrollTop: 0 }, 'slow');
        }
    });
</script>
{% endblock %}